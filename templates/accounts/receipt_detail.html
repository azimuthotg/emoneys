{% extends 'base_sidebar.html' %}
{% load humanize %}
{% load number_filters %}
{% block title %}{{ title }} - ระบบออกใบสำคัญรับเงิน{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{% block content %}
{% csrf_token %}
<!-- Toast Container -->
<div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 9999; right: 0;"></div>
<!-- Header Card -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card" style="background: linear-gradient(135deg,
            {% if pending_edit_request %}
                #fd7e14 0%, #e55d0c 100%
            {% elif receipt.status == 'draft' %}
                #ffc107 0%, #e0a800 100%
            {% elif receipt.status == 'completed' %}
                #28a745 0%, #20a742 100%
            {% else %}
                #6c757d 0%, #5a6268 100%
            {% endif %}
        );">
            <div class="card-body text-white py-2 px-3">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="mb-0 fw-bold">
                            <i class="fas fa-file-invoice-dollar me-2"></i>
                            {% if receipt.receipt_number %}
                                {{ receipt.receipt_number }}
                            {% else %}
                                <span class="opacity-75">(ร่าง - ยังไม่มีเลข)</span>
                            {% endif %}
                        </h6>
                        <small class="opacity-90">
                            <i class="fas fa-building me-1"></i>
                            {{ receipt.department.name }} ({{ receipt.department.code }})
                            <span class="ms-2">
                                <i class="fas fa-calendar me-1"></i>
                                {% if receipt.receipt_date %}
                                    {{ receipt.receipt_date|thai_date:"full" }}
                                {% else %}
                                    xx/xx/xxxx
                                {% endif %}
                            </span>
                        </small>
                    </div>
                    <div class="text-end">
                        <div class="mb-1">
                            {% if pending_edit_request %}
                                <span class="badge bg-warning text-dark small">มีคำขอแก้ไขรออนุมัติ</span>
                                <br>
                                <span class="badge bg-success mt-1 small">เสร็จสิ้น</span>
                            {% elif receipt.status == 'completed' %}
                                <span class="badge bg-success small">เสร็จสิ้น</span>
                            {% elif receipt.status == 'draft' %}
                                <span class="badge bg-warning text-dark small">ร่าง</span>
                            {% else %}
                                <span class="badge bg-danger small">ยกเลิก</span>
                            {% endif %}
                        </div>
                        <i class="fas fa-receipt" style="font-size: 2rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Request Status Alert -->
{% if rejected_edit_request %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning border-0 shadow-sm mb-0">
            <div class="d-flex align-items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle fa-lg text-warning"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <strong><i class="fas fa-ban me-1"></i>คำขอแก้ไขถูกปฏิเสธ</strong>
                    <div class="small mt-1">
                        <strong>คำขอเมื่อ:</strong> {{ rejected_edit_request.created_at|thai_date:"full" }} {{ rejected_edit_request.created_at|date:"H:i" }} |
                        <strong>ผู้ปฏิเสธ:</strong> {{ rejected_edit_request.approved_by.get_display_name }}
                        {% if rejected_edit_request.approval_notes %}
                        | <strong>เหตุผล:</strong> {{ rejected_edit_request.approval_notes }}
                        {% endif %}
                    </div>
                </div>
                <div class="flex-shrink-0 ms-3">
                    <a href="{% url 'edit_request_detail' rejected_edit_request.id %}" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-eye me-1"></i>ดูคำขอ {{ rejected_edit_request.request_number }}
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% elif pending_edit_request %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning border-0 shadow-sm mb-0">
            <div class="d-flex align-items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-clock fa-lg text-warning"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <strong><i class="fas fa-hourglass-half me-1"></i>คำขอแก้ไขรออนุมัติ</strong>
                    <div class="small mt-1">
                        <strong>ส่งคำขอเมื่อ:</strong> {{ pending_edit_request.created_at|thai_date:"full" }} {{ pending_edit_request.created_at|date:"H:i" }} |
                        <strong>ผู้ยื่นคำขอ:</strong> {{ pending_edit_request.requested_by.get_display_name }} |
                        <strong>เหตุผล:</strong> {{ pending_edit_request.reason }}
                    </div>
                </div>
                <div class="flex-shrink-0 ms-3">
                    <a href="{% url 'edit_request_detail' pending_edit_request.id %}" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-eye me-1"></i>ดูคำขอ {{ pending_edit_request.request_number }}
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Cancel Request Status Alert -->
{% if rejected_cancel_request %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning border-0 shadow-sm">
            <div class="d-flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle fa-lg text-warning"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <h6 class="alert-heading mb-2">
                        <i class="fas fa-ban me-2"></i>คำขอยกเลิกถูกปฏิเสธ
                    </h6>
                    <p class="mb-2">
                        <strong>คำขอเมื่อ:</strong> {{ rejected_cancel_request.created_at|thai_date:"full" }} {{ rejected_cancel_request.created_at|date:"H:i" }}<br>
                        <strong>ผู้ปฏิเสธ:</strong> {{ rejected_cancel_request.approved_by.get_display_name }}<br>
                        {% if rejected_cancel_request.approval_notes %}
                        <strong>เหตุผลการปฏิเสธ:</strong> {{ rejected_cancel_request.approval_notes }}
                        {% endif %}
                    </p>
                    <a href="{% url 'cancel_request_detail' rejected_cancel_request.id %}" class="btn btn-sm btn-outline-warning">
                        <i class="fas fa-eye me-1"></i>ดูรายละเอียดคำขอ
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% elif pending_cancel_request %}
<div class="row mb-3">
    <div class="col-12">
        <div class="alert alert-warning border-0 shadow-sm mb-0 py-3">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 me-3">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                    <div>
                        <h6 class="mb-1 fw-bold">
                            <i class="fas fa-file-times me-2"></i>คำขอยกเลิกรออนุมัติ
                        </h6>
                        <small class="mb-0">
                            <strong>ส่งคำขอเมื่อ:</strong> {{ pending_cancel_request.created_at|thai_date:"full" }} {{ pending_cancel_request.created_at|date:"H:i" }}
                            | <strong>ผู้ยื่นคำขอ:</strong> {{ pending_cancel_request.requested_by.get_display_name }}
                            | <strong>เหตุผล:</strong> {{ pending_cancel_request.cancel_reason|truncatewords:10 }}
                        </small>
                    </div>
                </div>
                <div class="flex-shrink-0">
                    <a href="{% url 'cancel_request_detail' pending_cancel_request.id %}" class="btn btn-outline-dark btn-sm">
                        <i class="fas fa-eye me-1"></i>ดูคำขอ {{ pending_cancel_request.request_number }}
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Status Info Legend -->
<div class="row mb-3">
    <div class="col-12">
        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#statusInfoLegend" aria-expanded="false" aria-controls="statusInfoLegend">
            <i class="fas fa-info-circle me-1"></i>
            คำแนะนำการใช้งาน
        </button>
        <div class="collapse mt-2" id="statusInfoLegend">
            <div class="card card-body border-0 shadow-sm bg-light">
                <div class="row g-3">
                    <!-- Draft Info -->
                    <div class="col-md-4">
                        <div class="d-flex align-items-start">
                            <div class="flex-shrink-0">
                                <span class="badge bg-warning text-dark" style="font-size: 0.9rem;">ร่าง</span>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-2 fw-bold text-warning">ใบสำคัญสถานะร่าง</h6>
                                <ul class="small mb-0 text-muted" style="line-height: 1.8;">
                                    <li><strong>แก้ไข:</strong> สามารถแก้ไขข้อมูลได้ทันที ไม่ต้องขออนุมัติ</li>
                                    <li><strong>ยกเลิก:</strong> สามารถยกเลิกได้ทันที ไม่ต้องขออนุมัติ</li>
                                    <li><strong>บันทึก:</strong> กดปุ่ม "บันทึกใบสำคัญ" เพื่อเปลี่ยนสถานะเป็น "เสร็จสิ้น"</li>
                                    <li class="text-primary"><i class="fas fa-lightbulb me-1"></i>ข้อมูลยังไม่มีผลทางบัญชี สามารถปรับแก้ได้อย่างอิสระ</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Completed Info -->
                    <div class="col-md-4">
                        <div class="d-flex align-items-start">
                            <div class="flex-shrink-0">
                                <span class="badge bg-success" style="font-size: 0.9rem;">เสร็จสิ้น</span>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-2 fw-bold text-success">ใบสำคัญสถานะเสร็จสิ้น</h6>
                                <ul class="small mb-0 text-muted" style="line-height: 1.8;">
                                    <li><strong>แก้ไข:</strong> ต้องส่ง "ขออนุมัติแก้ไข" และรอหัวหน้าแผนกอนุมัติ</li>
                                    <li><strong>ยกเลิก:</strong> ต้องส่ง "ขออนุมัติยกเลิก" และรอหัวหน้าแผนกอนุมัติ</li>
                                    <li><strong>สถานะ:</strong> ข้อมูลมีผลทางบัญชีแล้ว จึงต้องขออนุมัติก่อนดำเนินการ</li>
                                    <li class="text-danger"><i class="fas fa-shield-alt me-1"></i>การเปลี่ยนแปลงใดๆ ต้องผ่านการอนุมัติเพื่อความถูกต้อง</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Cancelled Info -->
                    <div class="col-md-4">
                        <div class="d-flex align-items-start">
                            <div class="flex-shrink-0">
                                <span class="badge bg-danger" style="font-size: 0.9rem;">ยกเลิก</span>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-2 fw-bold text-danger">ใบสำคัญสถานะยกเลิก</h6>
                                <ul class="small mb-0 text-muted" style="line-height: 1.8;">
                                    <li><strong>แก้ไข:</strong> ไม่สามารถแก้ไขได้ (ถูกยกเลิกแล้ว)</li>
                                    <li><strong>กู้คืน:</strong> ไม่สามารถกู้คืนได้ เมื่อยกเลิกแล้วเป็นอันสิ้นสุด</li>
                                    <li><strong>ดูข้อมูล:</strong> สามารถดูข้อมูลและ PDF เพื่ออ้างอิงได้</li>
                                    <li class="text-secondary"><i class="fas fa-ban me-1"></i>เอกสารถูกยกเลิกแล้ว ไม่มีผลทางบัญชี</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Actions -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body py-2">
                <div class="d-flex gap-2 flex-wrap">
                    <!-- PDF Actions -->
                    <button class="btn btn-primary btn-sm" onclick="printReceipt()">
                        <i class="fas fa-print me-1"></i>
                        ดู PDF
                    </button>
                    <button class="btn btn-info btn-sm" onclick="downloadPDF()">
                        <i class="fas fa-download me-1"></i>
                        ดาวน์โหลด PDF
                    </button>

                    <!-- Draft Actions -->
                    {% if receipt.status == 'draft' %}
                        <a href="{% url 'receipt_edit' receipt.id %}" class="btn btn-warning btn-sm">
                            <i class="fas fa-edit me-1"></i>
                            แก้ไขร่าง
                        </a>
                        <button type="button" class="btn btn-success px-4" onclick="completeDraft()">
                            <i class="fas fa-check-circle me-1"></i>
                            บันทึกใบสำคัญ
                        </button>
                    {% endif %}

                    <!-- Completed Actions: Request Edit -->
                    {% if receipt.status == 'completed' %}
                        {% if user_can_request_edit %}
                            {% if not receipt.has_pending_edit_request %}
                                <a href="{% url 'edit_request_create' receipt.id %}" class="btn btn-warning btn-sm">
                                    <i class="fas fa-edit me-1"></i>
                                    ขออนุมัติแก้ไข
                                </a>
                            {% endif %}
                        {% endif %}
                    {% endif %}

                    <!-- Cancel Buttons -->
                    {% if receipt.status != 'cancelled' %}
                        {% if can_be_cancelled_directly %}
                            <button type="button" class="btn btn-danger btn-sm" onclick="showCancelModal()">
                                <i class="fas fa-ban me-1"></i>
                                ยกเลิก
                            </button>
                        {% elif can_be_cancelled_by %}
                            <a href="{% url 'receipt_cancel_request' receipt.id %}" class="btn btn-outline-danger btn-sm">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                ขออนุมัติยกเลิก
                            </a>
                        {% endif %}
                    {% endif %}

                    <a href="{% url 'receipt_list' %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i>
                        กลับ
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Receipt Details -->
<div class="row">
    <div class="col-lg-8">
        <!-- Recipient Information -->
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-header bg-white border-0 py-2">
                <h6 class="mb-0 fw-bold text-success" style="font-size: 0.95rem;">
                    <i class="fas fa-user me-2"></i>
                    ข้อมูลผู้รับเงิน
                </h6>
            </div>
            <div class="card-body py-3">
                <div class="row g-2">
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-muted mb-1 small">ชื่อผู้รับเงิน</label>
                        <div class="border rounded p-2 bg-light small">{{ receipt.recipient_name }}</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-muted mb-1 small">เลขบัตรประชาชน</label>
                        <div class="border rounded p-2 bg-light font-monospace small">{{ receipt.recipient_id_card }}</div>
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-bold text-muted mb-1 small">ที่อยู่</label>
                        <div class="border rounded p-2 bg-light small">{{ receipt.recipient_address }}</div>
                    </div>
                    {% if receipt.recipient_postal_code %}
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-muted mb-1 small">รหัสไปรษณีย์</label>
                        <div class="border rounded p-2 bg-light small">{{ receipt.recipient_postal_code }}</div>
                    </div>
                    {% endif %}
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-muted mb-1 small">ประเภทการจ่าย</label>
                        <div class="border rounded p-2 bg-light">
                            {% if receipt.is_loan %}
                                <span class="badge bg-warning text-dark small">
                                    <i class="fas fa-handshake me-1"></i>
                                    ยืมเงิน
                                </span>
                            {% else %}
                                <span class="badge bg-primary small">
                                    <i class="fas fa-hand-holding-usd me-1"></i>
                                    จ่ายปกติ
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Receipt Items -->
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-header bg-white border-0 py-2">
                <h6 class="mb-0 fw-bold text-success" style="font-size: 0.95rem;">
                    <i class="fas fa-list me-2"></i>
                    รายการรับเงิน
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th width="10%">ลำดับ</th>
                                <th>รายการ</th>
                                <th width="20%" class="text-end">จำนวนเงิน</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in receipt.items.all %}
                            <tr>
                                <td class="text-center">{{ item.order }}</td>
                                <td>
                                    {{ item.description|safe }}
                                    {% if item.template %}
                                        <span class="badge bg-secondary ms-2">รายการสำเร็จรูป</span>
                                    {% endif %}
                                </td>
                                <td class="text-end font-monospace amount-cell" data-amount="{{ item.amount }}">{{ item.amount|floatformat:2|intcomma }} บาท</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-success">
                                <td colspan="2" class="fw-bold">รวมทั้งสิ้น</td>
                                <td class="text-end fw-bold font-monospace amount-cell" data-amount="{{ receipt.total_amount }}">{{ receipt.total_amount|floatformat:2|intcomma }} บาท</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="mt-3 pt-3 border-top">
                    <label class="form-label fw-bold text-muted">จำนวนเงิน (ตัวหนังสือ)</label>
                    <div class="border rounded p-3 bg-light font-thai h5 mb-0">
                        {{ receipt.total_amount_text }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Receipt Information -->
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-header bg-white border-0 py-2">
                <h6 class="mb-0 fw-bold text-success" style="font-size: 0.95rem;">
                    <i class="fas fa-info-circle me-2"></i>
                    ข้อมูลใบสำคัญ
                </h6>
            </div>
            <div class="card-body py-3">
                <div class="row g-2 text-start">
                    <div class="col-5">
                        <small class="text-muted">เลขที่เอกสาร:</small>
                    </div>
                    <div class="col-7">
                        <small class="fw-bold font-monospace">
                            {% if receipt.receipt_number %}
                                {{ receipt.receipt_number }}
                            {% else %}
                                <span class="text-muted">(ยังไม่มีเลข)</span>
                            {% endif %}
                        </small>
                    </div>
                    <div class="col-5">
                        <small class="text-muted">วันที่ออกใบสำคัญ:</small>
                    </div>
                    <div class="col-7">
                        <small class="fw-bold">
                            {% if receipt.receipt_date %}
                                {{ receipt.receipt_date|thai_date:"full" }}
                            {% else %}
                                <span class="text-muted">(ยังไม่ระบุ)</span>
                            {% endif %}
                        </small>
                    </div>
                    <div class="col-5">
                        <small class="text-muted">รหัสเล่ม:</small>
                    </div>
                    <div class="col-7">
                        <small class="fw-bold">{{ receipt.volume_code }}</small>
                    </div>
                    <div class="col-5">
                        <small class="text-muted">วันที่สร้าง:</small>
                    </div>
                    <div class="col-7">
                        <small>{{ receipt.created_at|thai_date:"full" }} {{ receipt.created_at|date:"H:i" }}</small>
                    </div>
                    <div class="col-5">
                        <small class="text-muted">ผู้สร้าง:</small>
                    </div>
                    <div class="col-7">
                        <small>{{ receipt.created_by.get_display_name }}</small>
                    </div>
                    <div class="col-5">
                        <small class="text-muted">สถานะ:</small>
                    </div>
                    <div class="col-7">
                        {% if receipt.status == 'completed' %}
                            <small><span class="badge bg-success small">เสร็จสิ้น</span></small>
                        {% elif receipt.status == 'draft' %}
                            <small><span class="badge bg-warning text-dark small">ร่าง</span></small>
                        {% else %}
                            <small><span class="badge bg-danger small">ยกเลิก</span></small>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Code - TEMPORARILY DISABLED FOR TESTING -->
        {% comment %}
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h6 class="mb-0 fw-bold text-success">
                    <i class="fas fa-qrcode me-2"></i>
                    QR Code ตรวจสอบ
                </h6>
            </div>
            <div class="card-body text-center">
                <div id="qr-code-container" class="mb-3">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">กำลังโหลด...</span>
                    </div>
                </div>
                <p class="small text-muted mb-2">สแกนเพื่อตรวจสอบความถูกต้อง</p>
                <button class="btn btn-sm btn-outline-info" onclick="copyVerificationURL()">
                    <i class="fas fa-copy me-1"></i>
                    คัดลอก URL
                </button>
            </div>
        </div>
        {% endcomment %}
    </div>
</div>

<!-- Change History (Audit Trail) -->
{% if change_logs %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h6 class="mb-0 fw-bold text-secondary">
                    <i class="fas fa-history me-2"></i>
                    ประวัติการเปลี่ยนแปลง
                </h6>
            </div>
            <div class="card-body">
                <div class="timeline">
                    {% for log in change_logs %}
                    <div class="timeline-item">
                        <div class="timeline-marker
                            {% if log.action == 'created' %}bg-primary
                            {% elif log.action == 'cancelled' %}bg-danger
                            {% elif log.action == 'edit_approved' %}bg-success
                            {% elif log.action == 'edit_rejected' %}bg-warning
                            {% else %}bg-info{% endif %}">
                            <i class="fas
                                {% if log.action == 'created' %}fa-plus
                                {% elif log.action == 'cancelled' %}fa-ban
                                {% elif log.action == 'updated' %}fa-edit
                                {% elif log.action == 'edit_requested' %}fa-paper-plane
                                {% elif log.action == 'edit_approved' %}fa-check
                                {% elif log.action == 'edit_rejected' %}fa-times
                                {% else %}fa-pen{% endif %}"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <h6 class="mb-0 fw-bold">{{ log.get_action_display }}</h6>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    {{ log.created_at|thai_date:"full" }} {{ log.created_at|date:"H:i" }}
                                </small>
                            </div>

                            {% if log.user %}
                            <p class="mb-1 small text-muted">
                                <i class="fas fa-user me-1"></i>
                                {{ log.user.get_display_name }}
                            </p>
                            {% endif %}

                            {% if log.notes %}
                            <p class="mb-1 small">
                                <i class="fas fa-comment-dots me-1"></i>
                                <span class="log-notes-text">{{ log.notes|striptags }}</span>
                            </p>
                            {% endif %}

                            {% if log.field_name and log.old_value %}
                            <div class="small text-muted">
                                <strong>{{ log.field_name }}:</strong>
                                <span class="text-decoration-line-through">{{ log.old_value }}</span>
                                →
                                <span class="text-success">{{ log.new_value }}</span>
                            </div>
                            {% endif %}

                            {% if log.edit_request %}
                            <div class="mt-2">
                                <a href="{% url 'edit_request_detail' log.edit_request.id %}" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-eye me-1"></i>
                                    ดูคำขอ {{ log.edit_request.request_number }}
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Cancel Reason Modal -->
<div class="modal fade" id="cancelReasonModal" tabindex="-1" aria-labelledby="cancelReasonModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="cancelReasonModalLabel">
                    <i class="fas fa-ban me-2"></i>
                    ยืนยันการยกเลิกใบสำคัญ
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="cancelForm" method="POST" action="{% url 'receipt_cancel_direct' receipt.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-warning border-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>คำเตือน:</strong> เมื่อยกเลิกแล้วจะไม่สามารถกู้คืนได้
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            เลขที่ใบสำคัญ
                        </label>
                        <input type="text" class="form-control" value="{% if receipt.receipt_number %}{{ receipt.receipt_number }}{% else %}(ยังไม่มีเลข){% endif %}" readonly>
                    </div>

                    <div class="mb-3">
                        <label for="cancel_reason" class="form-label fw-bold">
                            เหตุผลในการยกเลิก <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control" id="cancel_reason" name="cancel_reason" rows="4"
                                  placeholder="กรุณาระบุเหตุผลในการยกเลิกใบสำคัญนี้..." required></textarea>
                        <div class="form-text">
                            เหตุผลนี้จะถูกบันทึกในประวัติการเปลี่ยนแปลง
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        ยกเลิก
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-ban me-1"></i>
                        ยืนยันการยกเลิก
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Complete Confirmation Modal (for Draft) -->
<div class="modal fade" id="completeConfirmationModal" tabindex="-1" aria-labelledby="completeConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="completeConfirmationModalLabel">
                    <i class="fas fa-check-circle me-2"></i>
                    ยืนยันการบันทึกใบสำคัญรับเงิน
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Summary Section -->
                <div class="alert alert-info mb-4">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        สรุปข้อมูลใบสำคัญรับเงิน
                    </h6>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <strong>ชื่อผู้รับเงิน:</strong>
                            <div id="confirm-recipient-name" class="ms-3"></div>
                        </div>
                        <div class="col-md-6">
                            <strong>เลขบัตรประชาชน:</strong>
                            <div id="confirm-id-card" class="ms-3 font-monospace"></div>
                        </div>
                        <div class="col-12">
                            <strong>จำนวนเงินรวม:</strong>
                            <div id="confirm-total-amount" class="ms-3 fs-5 text-success fw-bold"></div>
                        </div>
                        <div class="col-12">
                            <strong>รายการ:</strong>
                            <div id="confirm-items-list" class="ms-3"></div>
                        </div>
                    </div>
                </div>

                <!-- Warning Section -->
                <div class="alert alert-warning mb-4">
                    <h6 class="fw-bold mb-2">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        คำเตือนสำคัญ
                    </h6>
                    <ul class="mb-0">
                        <li>เมื่อบันทึกเป็น <strong>"เสร็จสิ้น"</strong> แล้ว <strong class="text-danger">ไม่สามารถแก้ไขได้โดยตรง</strong></li>
                        <li>หากต้องการแก้ไข จะต้อง <strong>ส่งคำขอแก้ไข</strong> และรอการอนุมัติจากผู้จัดการ</li>
                        <li>กรุณาตรวจสอบข้อมูลให้ถูกต้องก่อนยืนยัน</li>
                    </ul>
                </div>

                <!-- Preview PDF Link -->
                <div class="text-center mb-3">
                    <button type="button" class="btn btn-outline-primary" onclick="openPreviewPDF()">
                        <i class="fas fa-file-pdf me-2"></i>
                        ดูตัวอย่าง PDF ก่อนบันทึก (แนะนำ)
                    </button>
                </div>

                <!-- Confirmation Checkbox -->
                <div class="form-check p-3 bg-light rounded">
                    <input class="form-check-input" type="checkbox" id="confirmCheckbox" onchange="toggleConfirmButton()">
                    <label class="form-check-label fw-bold" for="confirmCheckbox">
                        ข้าพเจ้าได้ตรวจสอบข้อมูลถูกต้องครบถ้วนแล้ว และยอมรับว่าหากต้องการแก้ไขจะต้องขออนุมัติ
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    ยกเลิก
                </button>
                <button type="button" class="btn btn-success" id="confirmCompleteBtn" onclick="confirmCompleteDraft()" disabled>
                    <i class="fas fa-check-circle me-2"></i>
                    ยืนยันบันทึกใบสำคัญ
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Load QR Code และ format ตัวเลข
document.addEventListener('DOMContentLoaded', function() {
    formatAmounts();
    highlightStatusInLogs();
});

function printReceipt() {
    window.open(`/receipt/{{ receipt.id }}/pdf/`, '_blank');
}

function printReceiptV2() {
    window.open(`/receipt/{{ receipt.id }}/pdf/v2/`, '_blank');
}

function downloadPDF() {
    const link = document.createElement('a');
    link.href = '/receipt/{{ receipt.id }}/pdf/download/';
    link.download = 'receipt-{% if receipt.receipt_number %}{{ receipt.receipt_number|slugify }}{% else %}{{ receipt.id }}{% endif %}.pdf';
    link.click();
}

function downloadPDFV2() {
    const link = document.createElement('a');
    link.href = '/receipt/{{ receipt.id }}/pdf/v2/download/';
    link.download = 'receipt-{% if receipt.receipt_number %}{{ receipt.receipt_number|slugify }}{% else %}{{ receipt.id }}{% endif %}_v2.pdf';
    link.click();
}

// Format amounts with commas
function formatAmounts() {
    document.querySelectorAll('.amount-cell').forEach(cell => {
        const amount = parseFloat(cell.dataset.amount);
        if (!isNaN(amount)) {
            const formattedAmount = amount.toLocaleString('th-TH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            cell.textContent = formattedAmount + ' บาท';
        }
    });
}

// Complete draft receipt
function completeDraft() {
    if (!confirm('ต้องการบันทึกใบสำคัญนี้หรือไม่?\n\nเมื่อบันทึกแล้ว สถานะจะเปลี่ยนเป็น "เสร็จสิ้น"')) {
        return;
    }

    // Get CSRF token from cookie or from the template
    const csrftoken = getCookie('csrftoken') || '{{ csrf_token }}';

    fetch(`/receipt/{{ receipt.id }}/complete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', 'บันทึกสำเร็จ!', 'กำลังรีโหลดหน้า...');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showToast('error', 'เกิดข้อผิดพลาด', data.message || 'ไม่สามารถบันทึกได้');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'เกิดข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์');
    });
}

// Show toast notification
function showToast(type, title, message) {
    const toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) return;

    const toastId = 'toast-' + Date.now();
    const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';

    const toastHTML = `
        <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true" style="margin-left: auto;">
            <div class="d-flex">
                <div class="toast-body">
                    <div class="d-flex align-items-start">
                        <i class="fas ${iconClass} fa-lg me-3 mt-1"></i>
                        <div>
                            <strong>${title}</strong><br>
                            ${message}
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;

    toastContainer.insertAdjacentHTML('beforeend', toastHTML);

    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: 4000
    });

    toast.show();

    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}

// Get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Show cancel modal
function showCancelModal() {
    const modal = new bootstrap.Modal(document.getElementById('cancelReasonModal'));
    modal.show();
}

// Show complete confirmation modal for draft
function showCompleteConfirmationFromDraft() {
    // Populate modal with receipt data
    document.getElementById('confirm-recipient-name').textContent = '{{ receipt.recipient_name }}';
    document.getElementById('confirm-id-card').textContent = '{{ receipt.recipient_id_card }}';
    document.getElementById('confirm-total-amount').textContent = '{{ receipt.total_amount|floatformat:2|intcomma }} บาท';

    // Show items list
    let itemsHTML = '<ul class="mb-0">';
    {% for item in receipt.items.all %}
    itemsHTML += '<li>{{ item.description|escapejs }}: {{ item.amount|floatformat:2|intcomma }} บาท</li>';
    {% endfor %}
    itemsHTML += '</ul>';
    document.getElementById('confirm-items-list').innerHTML = itemsHTML;

    // Reset checkbox
    document.getElementById('confirmCheckbox').checked = false;
    document.getElementById('confirmCompleteBtn').disabled = true;

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('completeConfirmationModal'));
    modal.show();
}

// Toggle confirm button based on checkbox
function toggleConfirmButton() {
    const checkbox = document.getElementById('confirmCheckbox');
    const confirmBtn = document.getElementById('confirmCompleteBtn');
    confirmBtn.disabled = !checkbox.checked;
}

// Open preview PDF in new window
function openPreviewPDF() {
    window.open('{% url "receipt_pdf" receipt.id %}', '_blank');
}

// Confirm and complete draft receipt
function confirmCompleteDraft() {
    // Hide modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('completeConfirmationModal'));
    modal.hide();

    // Get CSRF token from cookie or from the template
    const csrftoken = getCookie('csrftoken') || '{{ csrf_token }}';

    // Complete draft logic
    fetch('/accounts/receipt/{{ receipt.id }}/complete/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const receiptNumberText = data.receipt_number ? `เลขที่: ${data.receipt_number}` : '(ร่าง - ยังไม่มีเลข)';
            showToast('success', 'บันทึกสำเร็จ!', `${receiptNumberText}<br><small class="text-white opacity-75">กำลังรีเฟรชหน้า...</small>`);
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showToast('error', 'ผิดพลาด', data.message || 'เกิดข้อผิดพลาด');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'ผิดพลาด', 'เกิดข้อผิดพลาดในการเชื่อมต่อ');
    });
}

// Legacy function - now shows confirmation modal first
function completeDraft() {
    showCompleteConfirmationFromDraft();
}

// Highlight status keywords in change logs
function highlightStatusInLogs() {
    document.querySelectorAll('.log-notes-text').forEach(element => {
        let text = element.textContent;

        // Replace status keywords with colored badges
        text = text.replace(/ร่าง/g, '<span class="badge bg-warning text-dark">ร่าง</span>');
        text = text.replace(/เสร็จสิ้น/g, '<span class="badge bg-success">เสร็จสิ้น</span>');
        text = text.replace(/ยกเลิก/g, '<span class="badge bg-danger">ยกเลิก</span>');

        element.innerHTML = text;
    });
}
</script>

<style>
.font-thai {
    font-family: 'Sarabun', 'Kanit', sans-serif;
}
.font-monospace {
    font-family: 'Courier New', monospace;
}
.toast-body {
    padding: 1rem;
    color: white !important;
}
.toast-body * {
    color: white !important;
}

/* Timeline Styles */
.timeline {
    position: relative;
    padding-left: 40px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(to bottom, #e9ecef 0%, #dee2e6 100%);
}

.timeline-item {
    position: relative;
    padding-bottom: 30px;
}

.timeline-item:last-child {
    padding-bottom: 0;
}

.timeline-marker {
    position: absolute;
    left: -25px;
    top: 0;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 14px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    z-index: 1;
}

.timeline-content {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 3px solid #dee2e6;
    transition: all 0.3s ease;
}

.timeline-content:hover {
    background: #e9ecef;
    border-left-color: #6c757d;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
</style>
{% endblock %}