{% extends 'base_sidebar.html' %}
{% load humanize number_filters %}
{% block title %}{{ title }} - ระบบออกใบสำคัญรับเงิน{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<!-- Header Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card" style="background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);">
            <div class="card-body text-white p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-2 fw-bold">
                            <i class="fas fa-chart-pie me-2" style="color: #CFAE43;"></i>
                            รายงานแดชบอร์ด
                        </h5>
                        <p class="mb-0 opacity-90">
                            <i class="fas fa-eye me-2"></i>
                            ขอบเขตการดู: {{ view_scope }}
                        </p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <i class="fas fa-chart-line" style="font-size: 3rem; opacity: 0.3; color: #CFAE43;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <!-- 1. ยอดรวมทั้งปีงบประมาณ -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="text-start">
                        <h6 class="text-muted mb-1">ทั้งปีงบ {{ current_fiscal_year }}</h6>
                        <h3 class="mb-0" style="color: #002F6C;">{{ fiscal_year_amount|floatformat:0|intcomma }}</h3>
                        <small class="text-muted">บาท</small>
                    </div>
                    <div class="icon-circle" style="background: rgba(0, 47, 108, 0.1);">
                        <i class="fas fa-chart-pie" style="color: #002F6C;"></i>
                    </div>
                </div>
                <small class="text-muted">
                    <i class="fas fa-file-invoice me-1"></i>
                    {{ fiscal_year_count }} ใบสำคัญ
                </small>
            </div>
        </div>
    </div>
    
    <!-- 2. ยอดเดือนนี้ -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="text-start">
                        <h6 class="text-muted mb-1">เดือนนี้</h6>
                        <h3 class="mb-0" style="color: #198754;">{{ monthly_amount|floatformat:0|intcomma }}</h3>
                        <small class="text-muted">บาท</small>
                    </div>
                    <div class="icon-circle" style="background: rgba(25, 135, 84, 0.1);">
                        <i class="fas fa-calendar-alt" style="color: #198754;"></i>
                    </div>
                </div>
                <small class="text-muted">
                    <i class="fas fa-file-invoice me-1"></i>
                    {{ monthly_count }} ใบสำคัญ
                </small>
            </div>
        </div>
    </div>
    
    <!-- 3. เสร็จสิ้น -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="text-start">
                        <h6 class="text-muted mb-1">เสร็จสิ้น</h6>
                        <h3 class="mb-0" style="color: #0dcaf0;">{{ completed_count }}</h3>
                        <small class="text-muted">ใบสำคัญ</small>
                    </div>
                    <div class="icon-circle" style="background: rgba(13, 202, 240, 0.1);">
                        <i class="fas fa-check-circle" style="color: #0dcaf0;"></i>
                    </div>
                </div>
                <small class="text-muted">
                    <i class="fas fa-money-bill me-1"></i>
                    {{ completed_amount|floatformat:0|intcomma }} บาท
                </small>
            </div>
        </div>
    </div>
    
    <!-- 4. คำขอแก้ไข -->
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="text-start">
                        <h6 class="text-muted mb-1">คำขอแก้ไข</h6>
                        <h3 class="mb-0" style="color: #ffc107;">{{ pending_edit_requests }}</h3>
                        <small class="text-muted">รออนุมัติ</small>
                    </div>
                    <div class="icon-circle" style="background: rgba(255, 193, 7, 0.1);">
                        <i class="fas fa-edit" style="color: #ffc107;"></i>
                    </div>
                </div>
                <small class="text-muted">
                    <i class="fas fa-check me-1"></i>
                    {{ approved_edit_requests }} อนุมัติแล้ว
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Daily Statistics -->
    <div class="col-lg-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 py-3">
                <h6 class="mb-0 fw-bold text-primary">
                    <i class="fas fa-chart-line me-2"></i>
                    ยอดรายวัน (7 วันที่ผ่านมา)
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>วันที่/{{ current_thai_month }}</th>
                                <th class="text-center">จำนวน (ใบ)</th>
                                <th class="text-end">ยอดเงิน (บาท)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for daily in daily_stats %}
                            <tr>
                                <td>
                                    <span class="badge bg-{{ daily.day_color }} bg-opacity-75 me-2">{{ daily.day_short }}</span>
                                    {{ daily.date|thai_date:"short" }}
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-info">{{ daily.count }}</span>
                                </td>
                                <td class="text-end font-monospace">
                                    {{ daily.amount|floatformat:2|intcomma }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Status Summary -->
    <div class="col-lg-6 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 py-3">
                <h6 class="mb-0 fw-bold text-primary">
                    <i class="fas fa-chart-pie me-2"></i>
                    สรุปตามสถานะ
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>สถานะ</th>
                                <th class="text-center">จำนวน</th>
                                <th class="text-end">ยอดเงิน (บาท)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for status in status_summary %}
                            <tr>
                                <td>
                                    <span class="badge bg-{{ status.badge_color }} bg-opacity-75 me-2">{{ status.name }}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-info">{{ status.count }}</span>
                                    <small class="text-muted ms-1">{{ status.unit }}</small>
                                </td>
                                <td class="text-end font-monospace">
                                    {% if status.amount is not None %}
                                        {{ status.amount|floatformat:2|intcomma }}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Department Statistics (if available) -->
{% if department_stats %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h6 class="mb-0 fw-bold text-primary">
                    <i class="fas fa-building me-2"></i>
                    สรุปตามหน่วยงาน
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>หน่วยงาน</th>
                                <th class="text-center">จำนวนใบสำคัญ</th>
                                <th class="text-end">ยอดเงิน (บาท)</th>
                                <th class="text-center">สัดส่วน</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dept in department_stats %}
                            <tr>
                                <td>{{ dept.department }}</td>
                                <td class="text-center">
                                    <span class="badge bg-info">{{ dept.count }}</span>
                                </td>
                                <td class="text-end font-monospace">
                                    {{ dept.amount|floatformat:2|intcomma }}
                                </td>
                                <td class="text-center">
                                    {% widthratio dept.amount total_amount 100 as percentage %}
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" style="width: {{ percentage }}%">
                                            {{ percentage }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Action Buttons -->
<div class="row">
    <div class="col-12 text-center">
        <a href="{% url 'revenue_summary_report' %}" class="btn btn-success me-2">
            <i class="fas fa-chart-bar me-1"></i>
            รายงานสรุปรายรับ
        </a>
        <a href="{% url 'receipt_report' %}" class="btn btn-primary me-2">
            <i class="fas fa-table me-1"></i>
            รายงานแบบรายละเอียด
        </a>
        <a href="{% url 'receipt_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-list me-1"></i>
            ดูรายการใบสำคัญ
        </a>
    </div>
</div>

<style>
.icon-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
}

.font-monospace {
    font-family: 'Courier New', monospace;
}

.progress {
    background-color: #e9ecef;
}

.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.875rem;
}

.card {
    transition: transform 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
}
</style>
{% endblock %}