{% extends 'base_sidebar.html' %}
{% load humanize %}
{% block title %}ขออนุมัติแก้ไขใบสำคัญรับเงิน - ระบบออกใบสำคัญรับเงิน{% endblock %}
{% block page_title %}ขออนุมัติแก้ไขใบสำคัญรับเงิน{% endblock %}

{% block content %}
<!-- Header Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card" style="background: linear-gradient(135deg, #fd7e14 0%, #e55d0c 100%);">
            <div class="card-body text-white p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-2 fw-bold">
                            <i class="fas fa-paper-plane me-2" style="color: #CFAE43;"></i>
                            ขออนุมัติแก้ไขใบสำคัญรับเงิน
                        </h5>
                        <p class="mb-0 opacity-90">
                            <i class="fas fa-file-invoice me-2"></i>
                            ใบสำคัญเลขที่: {{ receipt.receipt_number }}
                        </p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <i class="fas fa-edit" style="font-size: 3rem; opacity: 0.3; color: #CFAE43;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Receipt Edit Form -->
<div class="row">
    <!-- Form Section (Left) -->
    <div class="col-lg-8">
        <form id="editRequestForm" method="post">
            {% csrf_token %}
            
            <!-- Recipient Information -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3">
                    <h6 class="mb-0 fw-bold" style="color: #fd7e14;">
                        <i class="fas fa-user me-2"></i>
                        ข้อมูลผู้รับเงิน <small class="text-muted">(แก้ไขข้อมูลที่ต้องการเปลี่ยน)</small>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="new_recipient_name" class="form-label fw-bold">ชื่อผู้รับเงิน</label>
                            <input type="text" class="form-control" id="new_recipient_name" name="new_recipient_name"
                                   value="{{ receipt.recipient_name }}" placeholder="ปัจจุบัน: {{ receipt.recipient_name }}">
                            <div class="form-text">ข้าพเจ้า ...</div>
                        </div>
                        <div class="col-12">
                            <label for="new_recipient_address" class="form-label fw-bold">ที่อยู่</label>
                            <textarea class="form-control" id="new_recipient_address" name="new_recipient_address" rows="3"
                                      placeholder="ปัจจุบัน: {{ receipt.recipient_address }}">{{ receipt.recipient_address }}</textarea>
                            <div class="form-text">บ้านเลขที่ หมู่ ซอย ถนน ตำบล อำเภอ จังหวัด</div>
                        </div>
                        <div class="col-md-6">
                            <label for="new_recipient_postal_code" class="form-label fw-bold">รหัสไปรษณีย์</label>
                            <input type="text" class="form-control" id="new_recipient_postal_code" name="new_recipient_postal_code"
                                   value="{{ receipt.recipient_postal_code }}" pattern="[0-9]{5}" maxlength="5"
                                   placeholder="ปัจจุบัน: {{ receipt.recipient_postal_code|default:'ไม่ระบุ' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="new_recipient_id_card" class="form-label fw-bold">เลขบัตรประชาชน</label>
                            <input type="text" class="form-control" id="new_recipient_id_card" name="new_recipient_id_card"
                                   value="{{ receipt.recipient_id_card }}" pattern="[0-9]{13}" maxlength="13"
                                   placeholder="ปัจจุบัน: {{ receipt.recipient_id_card }}">
                            <div class="form-text">13 หลัก ไม่ต้องใส่เครื่องหมาย</div>
                        </div>
                        <div class="col-12">
                            <label for="new_is_loan" class="form-label fw-bold">ประเภทการจ่าย</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="new_is_loan" id="new_is_loan_false" value="false"
                                       {% if not receipt.is_loan %}checked{% endif %}>
                                <label class="form-check-label" for="new_is_loan_false">
                                    <i class="fas fa-hand-holding-usd me-1"></i>
                                    จ่ายปกติ
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="new_is_loan" id="new_is_loan_true" value="true"
                                       {% if receipt.is_loan %}checked{% endif %}>
                                <label class="form-check-label" for="new_is_loan_true">
                                    <i class="fas fa-handshake me-1"></i>
                                    ยืมเงิน
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Receipt Items -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3">
                    <h6 class="mb-0 fw-bold" style="color: #fd7e14;">
                        <i class="fas fa-list me-2"></i>
                        รายการรับเงิน <small class="text-muted">(แก้ไขรายการที่มีอยู่เท่านั้น)</small>
                    </h6>
                </div>
                <div class="card-body">
                    <div>
                        <h6 class="fw-bold mb-2 small">รายการที่เพิ่มแล้ว</h6>
                    <div id="items-container">
                        {% for item in receipt.items.all %}
                        <div class="item-row border rounded p-2 mb-2" data-item-id="{{ forloop.counter0 }}">
                            <!-- Display Mode -->
                            <div class="item-display-mode">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="item-description-display mb-1">{{ item.description|linebreaksbr }}</div>
                                        <div class="text-muted">จำนวนเงิน: <span class="item-amount-display fw-bold">{{ item.amount|floatformat:2|intcomma }}</span> บาท</div>
                                        <input type="hidden" class="item-description-hidden" name="form-{{ forloop.counter0 }}-description" value="{{ item.description }}">
                                        <input type="hidden" class="item-amount-hidden" name="form-{{ forloop.counter0 }}-amount" value="{{ item.amount }}">
                                        <input type="hidden" class="item-quantity-hidden" name="form-{{ forloop.counter0 }}-quantity" value="1">
                                        <input type="hidden" class="item-unit-price-hidden" name="form-{{ forloop.counter0 }}-unit_price" value="{{ item.amount }}">
                                        <input type="hidden" name="form-{{ forloop.counter0 }}-id" value="{{ item.id }}">
                                    </div>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="editItem({{ forloop.counter0 }})" title="แก้ไข">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem({{ forloop.counter0 }})" title="ลบ">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Edit Mode (hidden by default) -->
                            <div class="item-edit-mode" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label fw-bold small">รายการ</label>
                                    <textarea class="form-control form-control-sm item-description-edit" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold small">จำนวนเงิน (บาท)</label>
                                    <input type="number" class="form-control form-control-sm item-amount-edit" step="0.01" value="{{ item.amount }}">
                                </div>
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-sm btn-success" onclick="saveItem({{ forloop.counter0 }})">
                                        <i class="fas fa-save me-1"></i> บันทึก
                                    </button>
                                    <button type="button" class="btn btn-sm btn-secondary" onclick="cancelEdit({{ forloop.counter0 }})">
                                        <i class="fas fa-times me-1"></i> ยกเลิก
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-list-alt fa-2x mb-2"></i>
                            <p>ไม่มีรายการ</p>
                        </div>
                        {% endfor %}
                    </div>
                    </div>
                    
                    <!-- Total Management Form Fields -->
                    <input type="hidden" id="id_form-TOTAL_FORMS" name="form-TOTAL_FORMS" value="{{ receipt.items.all|length }}">
                    <input type="hidden" id="id_form-INITIAL_FORMS" name="form-INITIAL_FORMS" value="{{ receipt.items.all|length }}">
                    <input type="hidden" id="id_form-MIN_NUM_FORMS" name="form-MIN_NUM_FORMS" value="0">
                    <input type="hidden" id="id_form-MAX_NUM_FORMS" name="form-MAX_NUM_FORMS" value="1000">
                    
                    <!-- Total Amount Display -->
                    <div class="row mt-4 pt-3 border-top">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">จำนวนเงินรวม (ตัวเลข)</label>
                            <div class="input-group">
                                <input type="text" class="form-control form-control-lg" id="total_amount_display" readonly
                                       value="{{ receipt.total_amount|floatformat:2|intcomma }}"
                                       style="font-size: 1.2rem; font-weight: bold; text-align: right;">
                                <span class="input-group-text">บาท</span>
                            </div>
                            <input type="hidden" id="total_amount" name="new_total_amount" value="{{ receipt.total_amount }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">จำนวนเงิน (ตัวหนังสือ)</label>
                            <input type="text" class="form-control form-control-lg" id="total_amount_text" readonly 
                                   style="font-family: 'Sarabun', sans-serif;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Request Reason -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3">
                    <h6 class="mb-0 fw-bold text-danger">
                        <i class="fas fa-comment-alt me-2"></i>
                        เหตุผลในการขอแก้ไข
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12">
                            <label for="reason" class="form-label fw-bold">
                                <span class="text-danger">*</span> เหตุผลในการขอแก้ไข
                            </label>
                            <textarea class="form-control" id="reason" name="reason" rows="4" required 
                                      placeholder="กรุณาระบุเหตุผลที่ชัดเจนสำหรับการขอแก้ไขใบสำคัญรับเงิน"></textarea>
                            <div class="form-text">เหตุผลนี้จะส่งไปยังหัวหน้าหน่วยงานเพื่อพิจารณาอนุมัติ</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row">
                <div class="col-12">
                    <div class="d-flex gap-2 justify-content-end">
                        <a href="{% url 'receipt_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>
                            ยกเลิก
                        </a>
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-paper-plane me-1"></i>
                            ส่งคำขอแก้ไข
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Current Receipt Preview (Right) -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm sticky-top" style="top: 2rem;">
            <div class="card-header bg-light border-0 py-3">
                <h6 class="mb-0 fw-bold text-muted">
                    <i class="fas fa-eye me-2"></i>
                    ข้อมูลปัจจุบัน
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6 class="fw-bold">{{ receipt.recipient_name }}</h6>
                    <p class="text-muted small mb-1">{{ receipt.recipient_address }}</p>
                    <p class="text-muted small mb-1">รหัสไปรษณีย์: {{ receipt.recipient_postal_code|default:'-' }}</p>
                    <p class="text-muted small font-monospace">เลขบัตรประชาชน: {{ receipt.recipient_id_card }}</p>
                </div>
                
                <div class="mb-3">
                    <h6 class="fw-bold">รายการสินค้า/บริการ</h6>
                    {% for item in receipt.items.all %}
                    <div class="d-flex justify-content-between align-items-center py-1">
                        <div>
                            <small>{{ item.description }}</small><br>
                            <small class="text-muted">จำนวน: 1</small>
                        </div>
                        <small class="fw-bold">{{ item.amount|floatformat:2|intcomma }}</small>
                    </div>
                    {% empty %}
                    <p class="text-muted small">ไม่มีรายการ</p>
                    {% endfor %}
                </div>
                
                <div class="border-top pt-3">
                    <div class="d-flex justify-content-between">
                        <strong>รวมทั้งหมด:</strong>
                        <strong class="text-success">{{ receipt.total_amount|floatformat:2|intcomma }} บาท</strong>
                    </div>
                </div>
                
                <div class="mt-3 pt-3 border-top">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        ข้อมูลด้านซ้ายจะถูกส่งเป็นคำขอแก้ไขไปยังหัวหน้าหน่วยงาน
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Help Text -->
<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-info" role="alert">
            <h6 class="alert-heading">
                <i class="fas fa-info-circle me-2"></i>
                คำแนะนำการใช้งาน
            </h6>
            <ul class="mb-0">
                <li>ข้อมูลในฟอร์มจะถูกโหลดจากใบสำคัญปัจจุบัน</li>
                <li>แก้ไขเฉพาะข้อมูลที่ต้องการเปลี่ยนแปลง</li>
                <li>สามารถเพิ่ม ลบ หรือแก้ไขรายการสินค้า/บริการได้</li>
                <li>ระบุเหตุผลในการขอแก้ไขให้ชัดเจน</li>
                <li>คำขอจะส่งไปยังหัวหน้าหน่วยงานเพื่อพิจารณาอนุมัติ</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Edit item - Switch to edit mode
function editItem(itemId) {
    const item = document.querySelector(`[data-item-id="${itemId}"]`);
    if (!item) return;

    // Get original content from hidden input
    const originalDesc = item.querySelector('.item-description-hidden').value;
    const originalAmount = parseFloat(item.querySelector('.item-amount-hidden').value) || 0;

    // Hide display mode, show edit mode
    item.querySelector('.item-display-mode').style.display = 'none';
    const editMode = item.querySelector('.item-edit-mode');
    editMode.style.display = 'block';

    // Set textarea value
    const textarea = editMode.querySelector('.item-description-edit');
    textarea.value = originalDesc.trim();
    editMode.querySelector('.item-amount-edit').value = originalAmount;
}

// Cancel edit - Switch back to display mode
function cancelEdit(itemId) {
    const item = document.querySelector(`[data-item-id="${itemId}"]`);
    if (!item) return;

    // Show display mode, hide edit mode
    item.querySelector('.item-display-mode').style.display = 'block';
    item.querySelector('.item-edit-mode').style.display = 'none';
}

// Save item - Update and switch back to display mode
function saveItem(itemId) {
    const item = document.querySelector(`[data-item-id="${itemId}"]`);
    if (!item) return;

    // Get new values from edit mode
    const textarea = item.querySelector('.item-description-edit');
    const newDescriptionText = textarea.value.trim();
    const newAmount = parseFloat(item.querySelector('.item-amount-edit').value) || 0;

    // Validate
    if (!newDescriptionText) {
        showToast('กรุณากรอกรายการ', 'warning');
        return;
    }

    if (newAmount <= 0) {
        showToast('กรุณากรอกจำนวนเงินที่ถูกต้อง', 'warning');
        return;
    }

    // Update hidden inputs (store plain text)
    item.querySelector('.item-description-hidden').value = newDescriptionText;
    item.querySelector('.item-amount-hidden').value = newAmount;

    // Update quantity and unit_price for formset (quantity=1, unit_price=amount)
    item.querySelector('.item-quantity-hidden').value = 1;
    item.querySelector('.item-unit-price-hidden').value = newAmount;

    // Update display (convert line breaks to <br> for display)
    const displayDescription = newDescriptionText.replace(/\n/g, '<br>');

    item.querySelector('.item-description-display').innerHTML = displayDescription;
    item.querySelector('.item-amount-display').textContent = newAmount.toLocaleString();

    // Show display mode, hide edit mode
    item.querySelector('.item-display-mode').style.display = 'block';
    item.querySelector('.item-edit-mode').style.display = 'none';

    // Recalculate total
    calculateTotal();
}

// Remove item
function removeItem(itemId) {
    showConfirm(
        'ต้องการลบรายการนี้หรือไม่?',
        function() {
            const item = document.querySelector(`[data-item-id="${itemId}"]`);
            if (item) {
                item.remove();
                calculateTotal();

                // Show empty message if no items left
                const container = document.getElementById('items-container');
                if (container.querySelectorAll('.item-row').length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-list-alt fa-2x mb-2"></i>
                            <p>ไม่มีรายการ</p>
                        </div>
                    `;
                }
            }
        },
        'ยืนยันการลบรายการ',
        'ลบ',
        'btn-danger'
    );
}

// Calculate total amount
function calculateTotal() {
    let total = 0;
    let itemCount = 0;

    // Use the hidden input fields to calculate total
    document.querySelectorAll('.item-amount-hidden').forEach(input => {
        const value = parseFloat(input.value) || 0;
        total += value;
        if (value > 0) itemCount++;
    });

    // Format number with commas for Thai display
    const formattedTotal = formatNumber(total);

    const totalField = document.getElementById('total_amount');
    const totalDisplayField = document.getElementById('total_amount_display');
    const totalTextField = document.getElementById('total_amount_text');

    if (totalField) {
        totalField.value = total;
    }

    if (totalDisplayField) {
        totalDisplayField.value = formattedTotal;
    }

    if (totalTextField) {
        totalTextField.value = convertToThaiText(total);
    }
}

// Format number with commas
function formatNumber(num) {
    if (num === null || num === undefined || num === '') return '0.00';

    const number = Number(num);
    if (isNaN(number)) return '0.00';

    const str = number.toFixed(2);
    const parts = str.split('.');
    const integerPart = parts[0];
    const decimalPart = parts[1];

    let formatted = '';
    for (let i = integerPart.length - 1, count = 0; i >= 0; i--, count++) {
        if (count > 0 && count % 3 === 0) {
            formatted = ',' + formatted;
        }
        formatted = integerPart[i] + formatted;
    }

    return formatted + '.' + decimalPart;
}

// Number to Thai text conversion (full version)
function convertToThaiText(number) {
    if (number === 0) return 'ศูนย์บาทถ้วน';

    const ones = ['', 'หนึ่ง', 'สอง', 'สาม', 'สี่', 'ห้า', 'หก', 'เจ็ด', 'แปด', 'เก้า'];
    const positions = ['', 'สิบ', 'ร้อย', 'พัน', 'หมื่น', 'แสน', 'ล้าน'];

    const baht = Math.floor(number);
    const satang = Math.round((number - baht) * 100);

    function convertGroup(num) {
        if (num === 0) return '';

        let text = '';
        const digits = num.toString().split('').reverse();

        for (let i = 0; i < digits.length; i++) {
            const digit = parseInt(digits[i]);

            if (digit === 0) continue;

            if (i === 1 && digit === 2) {
                // ตำแหน่งสิบ เลข 2 = "ยี่สิบ"
                text = 'ยี่' + positions[i] + text;
            } else if (i === 1 && digit === 1) {
                // ตำแหน่งสิบ เลข 1 = "สิบ"
                text = positions[i] + text;
            } else if (i === 0 && digit === 1 && digits.length > 1) {
                // ตำแหน่งหน่วย เลข 1 และมีหลักอื่น = "เอ็ด"
                text = 'เอ็ด' + text;
            } else {
                // กรณีปกติ
                text = ones[digit] + positions[i] + text;
            }
        }

        return text;
    }

    let result = '';

    if (baht > 0) {
        result = convertGroup(baht) + 'บาท';
    }

    if (satang > 0) {
        result += convertGroup(satang) + 'สตางค์';
    } else {
        result += 'ถ้วน';
    }

    return result;
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Calculate initial total
    calculateTotal();

    // Form validation
    document.getElementById('editRequestForm').addEventListener('submit', function(e) {
        const reason = document.getElementById('reason').value.trim();
        if (!reason) {
            e.preventDefault();
            showToast('กรุณาระบุเหตุผลในการขอแก้ไข', 'warning');
            return false;
        }
    });
});
</script>
{% endblock %}