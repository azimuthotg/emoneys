{% extends 'base_sidebar.html' %}
{% load humanize number_filters %}
{% block title %}{{ title }} - ระบบออกใบสำคัญรับเงิน{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<!-- Header Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card" style="background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);">
            <div class="card-body text-white p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-2 fw-bold">
                            <i class="fas fa-chart-bar me-2" style="color: #CFAE43;"></i>
                            รายงานสรุปรายรับ
                        </h5>
                        <p class="mb-0 opacity-90">
                            <i class="fas fa-eye me-2"></i>
                            ขอบเขตการดู: {{ view_scope }}
                        </p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <i class="fas fa-chart-pie" style="font-size: 3rem; opacity: 0.3; color: #CFAE43;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filter Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h6 class="mb-0 fw-bold text-primary">
                    <i class="fas fa-filter me-2"></i>
                    ตัวกรองข้อมูล
                </h6>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3" id="filterForm">
                    <div class="col-md-3">
                        <label class="form-label">ช่วงเวลา</label>
                        <select class="form-select" name="period" id="periodSelect">
                            <option value="daily" {% if period_type == 'daily' %}selected{% endif %}>รายวัน (30 วัน)</option>
                            <option value="monthly" {% if period_type == 'monthly' %}selected{% endif %}>รายเดือน (12 เดือน)</option>
                            <option value="fiscal_year" {% if period_type == 'fiscal_year' %}selected{% endif %}>รายปีงบประมาณ</option>
                        </select>
                        <small class="text-muted">หรือ</small>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">วันที่เริ่มต้น</label>
                        <input type="date" class="form-control" name="date_from" value="{{ date_from }}" id="dateFrom">
                        <small class="text-muted">กำหนดเอง</small>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">วันที่สิ้นสุด</label>
                        <input type="date" class="form-control" name="date_to" value="{{ date_to }}" id="dateTo">
                        <small class="text-muted">&nbsp;</small>
                    </div>
                    {% if departments.count > 1 %}
                    <div class="col-md-3">
                        <label class="form-label">หน่วยงาน</label>
                        <select class="form-select" name="department">
                            <option value="">ทุกหน่วยงาน</option>
                            {% for dept in departments %}
                            <option value="{{ dept.name }}" {% if department_filter == dept.name %}selected{% endif %}>
                                {{ dept.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search me-1"></i>กรอง
                            </button>
                            <a href="{% url 'revenue_summary_report' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-1"></i>ล้าง
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="card border-0 shadow-sm text-center">
            <div class="card-body">
                <h4 style="color: #002F6C;" class="mb-1">{{ total_summary.total_amount|floatformat:0|intcomma }}</h4>
                <small class="text-muted">บาท - ยอดรวมทั้งหมด</small>
            </div>
        </div>
    </div>
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="card border-0 shadow-sm text-center">
            <div class="card-body">
                <h4 style="color: #198754;" class="mb-1">{{ total_summary.total_count|intcomma }}</h4>
                <small class="text-muted">ใบสำคัญทั้งหมด</small>
            </div>
        </div>
    </div>
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="card border-0 shadow-sm text-center">
            <div class="card-body">
                <h4 style="color: #0dcaf0;" class="mb-1">{{ total_summary.total_departments }}</h4>
                <small class="text-muted">หน่วยงานที่มีข้อมูล</small>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Period Summary Chart -->
    <div class="col-lg-8 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 py-3">
                <h6 class="mb-0 fw-bold text-primary">
                    <i class="fas fa-chart-line me-2"></i>
                    {% if is_custom_mode %}
                        แนวโน้มรายรับ (รายวัน - กำหนดเอง)
                    {% else %}
                        แนวโน้มรายรับ
                        {% if period_type == 'daily' %}(รายวัน)
                        {% elif period_type == 'monthly' %}(รายเดือน)
                        {% else %}(รายปีงบประมาณ){% endif %}
                    {% endif %}
                </h6>
            </div>
            <div class="card-body">
                {% if is_custom_mode %}
                    {% if period_summary %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>วันที่</th>
                                        <th class="text-center">จำนวน (ใบ)</th>
                                        <th class="text-end">ยอดเงิน (บาท)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for period in period_summary %}
                                    <tr>
                                        <td>{{ period.period|thai_date:"short" }}</td>
                                        <td class="text-center">
                                            <span class="badge bg-info">{{ period.count }}</span>
                                        </td>
                                        <td class="text-end font-monospace">
                                            {{ period.amount|floatformat:2|intcomma }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-calendar-alt fa-3x mb-3"></i>
                            <h6>ไม่พบข้อมูลในช่วงที่กำหนด</h6>
                            <p class="mb-0">
                                {% if date_from and date_to %}
                                    ช่วงวันที่: {{ date_from }} ถึง {{ date_to }}
                                {% elif date_from %}
                                    ตั้งแต่วันที่: {{ date_from }}
                                {% elif date_to %}
                                    จนถึงวันที่: {{ date_to }}
                                {% endif %}
                            </p>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>ช่วงเวลา</th>
                                    <th class="text-center">จำนวน (ใบ)</th>
                                    <th class="text-end">ยอดเงิน (บาท)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for period in period_summary %}
                                <tr>
                                    <td>{{ period.period|thai_date:"short" }}</td>
                                    <td class="text-center">
                                        <span class="badge bg-info">{{ period.count }}</span>
                                    </td>
                                    <td class="text-end font-monospace">
                                        {{ period.amount|floatformat:2|intcomma }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Department Summary -->
    <div class="col-lg-4 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 py-3">
                <h6 class="mb-0 fw-bold text-primary">
                    <i class="fas fa-building me-2"></i>
                    สรุปตามหน่วยงาน
                </h6>
            </div>
            <div class="card-body">
                {% for dept in department_summary %}
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <div class="fw-bold">{{ dept.department_code }}</div>
                        <small class="text-muted">{{ dept.count }} ใบสำคัญ</small>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold">{{ dept.amount|floatformat:0|intcomma }}</div>
                        <small class="text-muted">{{ dept.percentage }}%</small>
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    ไม่พบข้อมูล
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Export Buttons -->
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <span class="text-muted">
                    <i class="fas fa-chart-bar me-1"></i>
                    รายงานสรุปรายรับ
                </span>
            </div>
            <div class="btn-group">
                <a href="{% url 'revenue_summary_excel_export' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" 
                   class="btn btn-success btn-sm">
                    <i class="fas fa-file-excel me-1"></i>
                    Export Excel
                </a>
                <a href="{% url 'revenue_summary_pdf_export' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}" 
                   class="btn btn-danger btn-sm" target="_blank">
                    <i class="fas fa-file-pdf me-1"></i>
                    Export PDF
                </a>
                <a href="{% url 'receipt_report' %}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-list me-1"></i>
                    รายละเอียด
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// Export functions - now handled by direct links

// Active/Disable Logic for Period vs Custom Date Range
document.addEventListener('DOMContentLoaded', function() {
    const periodSelect = document.getElementById('periodSelect');
    const dateFrom = document.getElementById('dateFrom');
    const dateTo = document.getElementById('dateTo');
    
    function updateFilterState() {
        const hasCustomDate = dateFrom.value || dateTo.value;
        
        if (hasCustomDate) {
            // ใช้วันที่กำหนดเอง - disable period select
            periodSelect.disabled = true;
            periodSelect.style.opacity = '0.5';
            periodSelect.parentElement.querySelector('small').innerHTML = '<span class="text-warning">ปิดใช้งาน (ใช้วันที่กำหนดเอง)</span>';
        } else {
            // ใช้ period select - enable ปกติ
            periodSelect.disabled = false;
            periodSelect.style.opacity = '1';
            periodSelect.parentElement.querySelector('small').innerHTML = 'หรือ';
        }
    }
    
    function clearAndUpdate(clearTarget) {
        if (clearTarget === 'dates') {
            dateFrom.value = '';
            dateTo.value = '';
        }
        updateFilterState();
    }
    
    // Event listeners
    periodSelect.addEventListener('change', function() {
        if (this.value) {
            clearAndUpdate('dates');
        }
    });
    
    dateFrom.addEventListener('change', updateFilterState);
    dateTo.addEventListener('change', updateFilterState);
    
    // ไม่ต้องเพิ่มปุ่มล้างค่า เพราะมีปุ่ม "ล้าง" อยู่แล้ว
    
    // เรียกใช้ครั้งแรกเมื่อโหลดหน้า
    updateFilterState();
});
</script>

<style>
.font-monospace {
    font-family: 'Courier New', monospace;
}

.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.875rem;
    background-color: #f8f9fa;
}

.table tbody tr {
    transition: background-color 0.2s ease;
}

.table tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

.card {
    transition: transform 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
}
</style>
{% endblock %}