{% extends 'base_sidebar.html' %}
{% block title %}Dashboard Admin - ระบบออกใบสำคัญรับเงิน{% endblock %}
{% block page_title %}Dashboard ผู้ดูแลระบบ{% endblock %}

{% block content %}
<!-- Welcome Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card" style="background: linear-gradient(135deg, #002F6C 0%, #001a3d 100%);">
            <div class="card-body text-white p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-2 fw-bold">
                            <i class="fas fa-user-shield me-2" style="color: #CFAE43;"></i>
                            ยินดีต้อนรับ, {{ user.full_name|default:user.username }}
                        </h5>
                        <p class="mb-0 opacity-90">
                            <i class="fas fa-crown me-2"></i>
                            ผู้ดูแลระบบออกใบสำคัญรับเงิน
                        </p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <i class="fas fa-tools" style="font-size: 3rem; opacity: 0.3; color: #CFAE43;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Statistics Cards (Minimal) -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-3 px-4">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-users" style="font-size: 1.8rem; color: #002F6C;"></i>
                        </div>
                        <div>
                            <h3 class="mb-0 fw-bold" style="color: #002F6C;">{{ admin_stats.total_users|default:0 }}</h3>
                            <small class="text-muted">ผู้ใช้ทั้งหมด</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-3 px-4">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-hourglass-half" style="font-size: 1.8rem; color: #CFAE43;"></i>
                        </div>
                        <div>
                            <h3 class="mb-0 fw-bold" style="color: #CFAE43;">{{ admin_stats.pending_users|default:0 }}</h3>
                            <small class="text-muted">รออนุมัติ</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-3 px-4">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-check-circle" style="font-size: 1.8rem; color: #28a745;"></i>
                        </div>
                        <div>
                            <h3 class="mb-0 fw-bold text-success">{{ admin_stats.approved_users|default:0 }}</h3>
                            <small class="text-muted">อนุมัติแล้ว</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body py-3 px-4">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="fas fa-receipt" style="font-size: 1.8rem; color: #002F6C;"></i>
                        </div>
                        <div>
                            <h3 class="mb-0 fw-bold" style="color: #002F6C;">{{ admin_stats.total_receipts|default:0 }}</h3>
                            <small class="text-muted">ใบสำคัญ</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Pending Users Section -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-user-clock text-warning me-2"></i>
                        ผู้ใช้ที่รออนุมัติ
                        {% if pending_users %}
                            <span class="badge bg-warning ms-2">{{ pending_users|length }}</span>
                        {% endif %}
                    </h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportUsers()">
                            <i class="fas fa-download me-1"></i>ส่งออกข้อมูล
                        </button>
                        <a href="/admin/" class="btn btn-sm btn-outline-danger">
                            <i class="fas fa-cogs me-1"></i>Django Admin
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if pending_users %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                        <th>รหัสบัตรประชาชน</th>
                                        <th>ชื่อ-นามสกุล</th>
                                        <th>หน่วยงาน</th>
                                        <th>ตำแหน่ง</th>
                                        <th>วันที่สมัคร</th>
                                        <th class="text-center">การดำเนินการ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in pending_users %}
                                    <tr id="user-row-{{ user.id }}">
                                        <td>
                                            <input type="checkbox" class="user-checkbox" value="{{ user.id }}">
                                        </td>
                                        <td>
                                            <strong>{{ user.ldap_uid }}</strong>
                                        </td>
                                        <td>
                                            <div>
                                                <strong>{{ user.full_name|default:"ไม่ระบุ" }}</strong>
                                                <br>
                                                <small class="text-muted">{{ user.username }}</small>
                                            </div>
                                        </td>
                                        <td>{{ user.get_department|default:"ไม่ระบุ" }}</td>
                                        <td>{{ user.position_title|default:"ไม่ระบุ" }}</td>
                                        <td>
                                            <small>{{ user.date_joined|date:"d/m/Y H:i" }}</small>
                                        </td>
                                        <td class="text-center">
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-success" onclick="approveUser({{ user.id }})" title="อนุมัติ">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button class="btn btn-danger" onclick="rejectUser({{ user.id }})" title="ปฏิเสธ">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                                <button class="btn btn-info" onclick="viewUserDetails({{ user.id }})" title="ดูรายละเอียด">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-success me-2" onclick="approveSelectedUsers()">
                                <i class="fas fa-check-double me-1"></i>
                                อนุมัติที่เลือก
                            </button>
                            <button class="btn btn-danger" onclick="rejectSelectedUsers()">
                                <i class="fas fa-times me-1"></i>
                                ปฏิเสธที่เลือก
                            </button>
                        </div>
                    {% else %}
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-user-check fa-3x mb-3 opacity-50"></i>
                            <p>ไม่มีผู้ใช้ที่รออนุมัติ</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user me-2"></i>รายละเอียดผู้ใช้
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userDetailsContent">
                <!-- Content loaded via AJAX -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
            </div>
        </div>
    </div>
</div>

<!-- User Role Assignment Modal -->
<div class="modal fade" id="userRoleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #f8fafc; border-bottom: 2px solid #CFAE43;">
                <h5 class="modal-title">
                    <i class="fas fa-user-tag me-2" style="color: #CFAE43;"></i>กำหนดบทบาทผู้ใช้
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label fw-bold">ผู้ใช้</label>
                    <div class="form-control-plaintext" id="selectedUserName">
                        <!-- User name will be populated here -->
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">บทบาทที่จะกำหนด</label>
                    <div class="border rounded p-3" style="max-height: 200px; overflow-y: auto;" id="roleCheckboxes">
                        <!-- Roles will be loaded here via AJAX -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn" style="background-color: #CFAE43; color: white;" onclick="saveUserRoles()">
                    <i class="fas fa-save me-1"></i>บันทึกบทบาท
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// CSRF Token for AJAX requests
const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

// Approve user function
function approveUser(userId) {
    if (confirm('คุณต้องการอนุมัติผู้ใช้นี้หรือไม่?')) {
        fetch(`/accounts/management/approve-user/${userId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById(`user-row-${userId}`).remove();
                showToast('success', 'อนุมัติผู้ใช้เรียบร้อย');
                updateStats();
            } else {
                showToast('error', data.message || 'เกิดข้อผิดพลาด');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('error', 'เกิดข้อผิดพลาดในการติดต่อเซิร์ฟเวอร์');
        });
    }
}

// Reject user function
function rejectUser(userId) {
    if (confirm('คุณต้องการปฏิเสธผู้ใช้นี้หรือไม่?')) {
        fetch(`/accounts/management/reject-user/${userId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById(`user-row-${userId}`).remove();
                showToast('warning', 'ปฏิเสธผู้ใช้เรียบร้อย');
                updateStats();
            } else {
                showToast('error', data.message || 'เกิดข้อผิดพลาด');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('error', 'เกิดข้อผิดพลาดในการติดต่อเซิร์ฟเวอร์');
        });
    }
}

// View user details function
function viewUserDetails(userId) {
    fetch(`/accounts/management/user-details/${userId}/`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('userDetailsContent').innerHTML = data.html;
            const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
            modal.show();
        } else {
            showToast('error', 'ไม่สามารถโหลดข้อมูลผู้ใช้ได้');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'เกิดข้อผิดพลาดในการโหลดข้อมูล');
    });
}

// Export users
function exportUsers() {
    showToast('info', 'กำลังเตรียมไฟล์ส่งออก...');
    // Implementation for export functionality
}

// Show pending users (for quick action button)
function showPendingUsers() {
    // Since we're now using tabs, just make sure users tab is active
    const usersTab = document.getElementById('users-tab');
    if (usersTab) {
        usersTab.click();
    }
}

// Toggle select all checkboxes
function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.user-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

// Approve selected users
function approveSelectedUsers() {
    const selected = getSelectedUsers();
    if (selected.length === 0) {
        showToast('warning', 'กรุณาเลือกผู้ใช้ที่ต้องการอนุมัติ');
        return;
    }
    
    if (confirm(`คุณต้องการอนุมัติผู้ใช้ ${selected.length} คน ใช่หรือไม่?`)) {
        showToast('info', 'กำลังอนุมัติผู้ใช้...');
        // Implementation for bulk approval
        selected.forEach(userId => {
            setTimeout(() => approveUser(userId), 100);
        });
    }
}

// Reject selected users  
function rejectSelectedUsers() {
    const selected = getSelectedUsers();
    if (selected.length === 0) {
        showToast('warning', 'กรุณาเลือกผู้ใช้ที่ต้องการปฏิเสธ');
        return;
    }
    
    if (confirm(`คุณต้องการปฏิเสธผู้ใช้ ${selected.length} คน ใช่หรือไม่?`)) {
        showToast('info', 'กำลังปฏิเสธผู้ใช้...');
        // Implementation for bulk rejection
        selected.forEach(userId => {
            setTimeout(() => rejectUser(userId), 100);
        });
    }
}

// Get selected user IDs
function getSelectedUsers() {
    const checkboxes = document.querySelectorAll('.user-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}


// Update statistics after approval/rejection
function updateStats() {
    // Could implement AJAX stats update here
    setTimeout(() => {
        location.reload();
    }, 1000);
}

// Show toast notification
function showToast(type, message) {
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();
    const toast = document.createElement('div');
    toast.className = 'toast show';
    
    // ใช้สีตาม design guideline
    let bgClass, icon, title;
    if (type === 'success') {
        bgClass = 'bg-success';
        icon = 'check-circle';
        title = 'สำเร็จ';
    } else if (type === 'warning') {
        bgClass = 'text-dark';
        icon = 'exclamation-triangle';
        title = 'แจ้งเตือน';
        toast.style.backgroundColor = '#CFAE43';
    } else if (type === 'info') {
        bgClass = 'text-white';
        icon = 'info-circle';
        title = 'ข้อมูล';
        toast.style.backgroundColor = '#002F6C';
    } else {
        bgClass = 'bg-danger';
        icon = 'times-circle';
        title = 'ข้อผิดพลาด';
    }
    
    toast.innerHTML = `
        <div class="toast-header ${bgClass}">
            <strong class="me-auto">
                <i class="fas fa-${icon} me-2"></i>${title}
            </strong>
            <button type="button" class="btn-close ${type === 'warning' || type === 'info' ? 'btn-close-white' : ''}" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">${message}</div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Create toast container if it doesn't exist
function createToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1055';
    document.body.appendChild(container);
    return container;
}

// User role assignment variables
let currentUserId = null;

// Show user role assignment modal
function assignUserRole(userId) {
    currentUserId = userId;
    
    // Load user info and roles
    fetch(`/accounts/management/user/${userId}/assign-roles/`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Set user name
            document.getElementById('selectedUserName').innerHTML = `
                <strong>${data.user.name}</strong>
                <small class="text-muted d-block">ID: ${data.user.id}</small>
            `;
            
            // Load all roles and check current user roles
            loadRolesForUser(data.user.role_ids);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('userRoleModal'));
            modal.show();
        } else {
            showToast('error', 'ไม่สามารถโหลดข้อมูลผู้ใช้ได้');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'เกิดข้อผิดพลาดในการโหลดข้อมูล');
    });
}

// Load roles for user assignment
function loadRolesForUser(userRoleIds = []) {
    fetch('/accounts/management/roles-permissions/')
    .then(response => response.text())
    .then(html => {
        // Extract roles from the response (this is a simple approach)
        // In a real app, you'd have a dedicated API endpoint for roles
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Create role checkboxes
        let rolesHtml = `
            <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" value="1" id="role1" ${userRoleIds.includes(1) ? 'checked' : ''}>
                <label class="form-check-label" for="role1">
                    <strong>ผู้ใช้พื้นฐาน</strong>
                    <br><small class="text-muted">ผู้ใช้ทั่วไปที่สามารถสร้างใบสำคัญรับเงินและดูของตัวเองได้</small>
                </label>
            </div>
            <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" value="2" id="role2" ${userRoleIds.includes(2) ? 'checked' : ''}>
                <label class="form-check-label" for="role2">
                    <strong>ผู้ดูแลหน่วยงาน</strong>
                    <br><small class="text-muted">ผู้ดูแลหน่วยงานที่สามารถจัดการใบสำคัญรับเงินของหน่วยงานตัวเอง</small>
                </label>
            </div>
        `;
        
        document.getElementById('roleCheckboxes').innerHTML = rolesHtml;
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('roleCheckboxes').innerHTML = '<p class="text-danger">เกิดข้อผิดพลาดในการโหลดบทบาท</p>';
    });
}

// Save user roles
function saveUserRoles() {
    if (!currentUserId) {
        showToast('error', 'ไม่พบข้อมูลผู้ใช้');
        return;
    }
    
    // Get selected roles
    const roleIds = Array.from(document.querySelectorAll('#roleCheckboxes input[type="checkbox"]:checked'))
        .map(cb => parseInt(cb.value));
    
    fetch(`/accounts/management/user/${currentUserId}/assign-roles/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ role_ids: roleIds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', data.message);
            bootstrap.Modal.getInstance(document.getElementById('userRoleModal')).hide();
            // Reload page to show updated roles
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('error', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'เกิดข้อผิดพลาดในการบันทึก');
    });
}

// Load roles tab content via AJAX
function loadRolesTab() {
    const content = document.getElementById('rolesTabContent');
    content.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x"></i><p class="mt-2">กำลังโหลดข้อมูล...</p></div>';
    
    fetch('/accounts/management/roles-permissions/')
    .then(response => response.text())
    .then(html => {
        // Extract only the main content from the roles page
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Get the roles and permissions content
        const rolesSection = doc.querySelector('[id="mainContentArea"]');
        
        if (rolesSection) {
            content.innerHTML = rolesSection.innerHTML;
        } else {
            content.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i>ไม่สามารถโหลดข้อมูลได้</div>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        content.innerHTML = '<div class="alert alert-danger"><i class="fas fa-times-circle me-2"></i>เกิดข้อผิดพลาดในการโหลดข้อมูล</div>';
    });
}

// Initialize tabs
document.addEventListener('DOMContentLoaded', function() {
    // Auto-load first tab content (users tab is default)
    // No need to load as it's already in the HTML
    
    // Add tab switch event listeners
    const tabButtons = document.querySelectorAll('#adminTabs button[data-bs-toggle="tab"]');
    tabButtons.forEach(button => {
        button.addEventListener('shown.bs.tab', function(event) {
            const targetId = event.target.getAttribute('data-bs-target');
            
            // Auto-load content for certain tabs when they become active
            if (targetId === '#roles-pane') {
                const rolesContent = document.getElementById('rolesTabContent');
                // Only load if content is empty (first time)
                if (rolesContent && rolesContent.innerHTML.includes('คลิก "โหลดข้อมูล"')) {
                    loadRolesTab();
                }
            }
        });
    });
});
</script>
{% endblock %}