{% extends 'base_sidebar.html' %}
{% load humanize %}
{% load static %}
{% load number_filters %}

{% block title %}{{ title }} - ระบบออกใบสำคัญรับเงิน{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{% block extra_css %}
<!-- Custom CSS -->
{% endblock %}

{% block content %}
<!-- Header Card -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card" style="background: linear-gradient(135deg, #CFAE43 0%, #b8951a 100%);">
            <div class="card-body text-white py-2 px-3">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="mb-0 fw-bold">
                            <i class="fas fa-file-plus me-2" style="color: #002F6C;"></i>
                            สร้างใบสำคัญรับเงิน
                        </h6>
                        <small class="opacity-90">
                            <i class="fas fa-building me-1"></i>
                            {{ department.name }} ({{ department.code }})
                        </small>
                    </div>
                    <i class="fas fa-receipt" style="font-size: 2rem; opacity: 0.3; color: #002F6C;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Receipt Form -->
<div class="row">
    <!-- Form Section (Full Width) -->
    <div class="col-12">
        <form id="receiptForm">
            {% csrf_token %}
            
            <!-- Recipient Information -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-white border-0 py-2">
                    <h6 class="mb-0 fw-bold" style="color: #CFAE43; font-size: 0.95rem;">
                        <i class="fas fa-user me-2"></i>
                        ข้อมูลผู้รับเงิน
                    </h6>
                </div>
                <div class="card-body py-3">
                    <div class="row g-2">
                        <div class="col-md-12">
                            <label for="recipient_name" class="form-label fw-bold mb-1 small">ชื่อผู้รับเงิน <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="recipient_name" name="recipient_name" required placeholder="ข้าพเจ้า...">
                        </div>
                        <div class="col-md-12">
                            <label for="recipient_address" class="form-label fw-bold mb-1 small">ที่อยู่ <span class="text-danger">*</span></label>
                            <textarea class="form-control form-control-sm" id="recipient_address" name="recipient_address" rows="2" required placeholder="บ้านเลขที่ หมู่ ซอย ถนน ตำบล อำเภอ จังหวัด"></textarea>
                        </div>
                        <div class="col-md-4">
                            <label for="recipient_postal_code" class="form-label fw-bold mb-1 small">รหัสไปรษณีย์</label>
                            <input type="text" class="form-control form-control-sm" id="recipient_postal_code" name="recipient_postal_code"
                                   pattern="[0-9]{5}" maxlength="5" placeholder="5 หลัก">
                        </div>
                        <div class="col-md-4">
                            <label for="recipient_id_card" class="form-label fw-bold mb-1 small">เลขบัตรประชาชน <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="recipient_id_card" name="recipient_id_card"
                                   pattern="[0-9]{13}" maxlength="13" required placeholder="13 หลัก">
                        </div>
                        <div class="col-md-4">
                            <label for="receipt_date" class="form-label fw-bold mb-1 small">วันที่ออกใบสำคัญ <span class="text-danger">*</span></label>
                            <input type="date" class="form-control form-control-sm" id="receipt_date" name="receipt_date" required>
                            <div class="form-text small" id="receipt_date_help" style="font-size: 0.7rem;">ย้อนหลังได้ถึงต้นปีงบฯ</div>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold mb-1 small">ประเภทการจ่าย</label>
                            <div class="d-flex gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="is_loan" id="is_loan_false" value="false" checked>
                                    <label class="form-check-label small" for="is_loan_false">
                                        <i class="fas fa-hand-holding-usd me-1"></i>
                                        จ่ายปกติ
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="is_loan" id="is_loan_true" value="true">
                                    <label class="form-check-label small" for="is_loan_true">
                                        <i class="fas fa-handshake me-1"></i>
                                        ยืมเงิน (ใช้ชื่อ {{ user_full_name }} เป็นผู้จ่าย)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Receipt Items -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-white border-0 py-2">
                    <h6 class="mb-0 fw-bold" style="color: #CFAE43; font-size: 0.95rem;">
                        <i class="fas fa-list me-2"></i>
                        รายการรับเงิน
                    </h6>
                </div>
                <div class="card-body py-3">
                    <!-- Template Dropdown -->
                    <div class="row g-2 mb-3">
                        <div class="col-md-12">
                            <label class="form-label fw-bold mb-1 small">เลือกประเภทรายการ</label>
                            <select class="form-select form-select-sm" id="template-select" onchange="handleTemplateChange()">
                                <option value="">-- เลือกประเภทรายการ --</option>
                                {% for template in receipt_templates %}
                                <option value="{{ template.id }}"
                                        data-name="{{ template.name }}"
                                        data-input-type="{{ template.input_type }}"
                                        data-max-amount="{{ template.max_amount|default:'0' }}"
                                        data-sub-items='{{ template.sub_items|tojson }}'>
                                    {{ template.name }}
                                    {% if template.max_amount %}(สูงสุด {{ template.max_amount|floatformat:0|intcomma }} บาท){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Dynamic Input Fields Container -->
                    <div id="dynamic-fields-container">
                        <!-- Dynamic fields will be inserted here based on selected template -->
                    </div>

                    <!-- Items List -->
                    <div class="mt-3">
                        <h6 class="fw-bold mb-2 small">รายการที่เพิ่มแล้ว</h6>
                    <div id="items-container">
                        <!-- Items will be added here dynamically -->
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-list-alt fa-2x mb-2"></i>
                            <p>กรุณาเพิ่มรายการรับเงิน</p>
                        </div>
                    </div>

                    <!-- Total Amount Display -->
                    <div class="row mt-3 pt-2 border-top">
                        <div class="col-md-6">
                            <label class="form-label fw-bold mb-1 small">จำนวนเงินรวม (ตัวเลข)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="total_amount_display" readonly
                                       style="font-size: 1.1rem; font-weight: bold; text-align: right;">
                                <span class="input-group-text">บาท</span>
                            </div>
                            <!-- Hidden field สำหรับเก็บค่าตัวเลขจริง -->
                            <input type="hidden" id="total_amount" name="total_amount">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold mb-1 small">จำนวนเงิน (ตัวหนังสือ)</label>
                            <input type="text" class="form-control" id="total_amount_text" readonly
                                   style="font-family: 'Sarabun', sans-serif;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row">
                <div class="col-12">
                    <div class="d-flex gap-2 justify-content-end align-items-center">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="resetForm()">
                            <i class="fas fa-redo me-1"></i>
                            เคลียร์ฟอร์ม
                        </button>
                        <button type="button" class="btn btn-warning btn-sm" onclick="saveDraft()">
                            <i class="fas fa-save me-1"></i>
                            บันทึกร่าง
                        </button>
                        <button type="button" class="btn btn-success px-4" onclick="showCompleteConfirmation()">
                            <i class="fas fa-check-circle me-2"></i>
                            บันทึกใบสำคัญ
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>


<!-- Toast Container -->
<div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 9999; right: 0;">
    <!-- Toasts will be inserted here dynamically -->
</div>

<!-- Complete Confirmation Modal -->
<div class="modal fade" id="completeConfirmationModal" tabindex="-1" aria-labelledby="completeConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="completeConfirmationModalLabel">
                    <i class="fas fa-check-circle me-2"></i>
                    ยืนยันการบันทึกใบสำคัญรับเงิน
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Summary Section -->
                <div class="alert alert-info mb-4">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        สรุปข้อมูลใบสำคัญรับเงิน
                    </h6>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <strong>ชื่อผู้รับเงิน:</strong>
                            <div id="confirm-recipient-name" class="ms-3"></div>
                        </div>
                        <div class="col-md-6">
                            <strong>เลขบัตรประชาชน:</strong>
                            <div id="confirm-id-card" class="ms-3 font-monospace"></div>
                        </div>
                        <div class="col-12">
                            <strong>จำนวนเงินรวม:</strong>
                            <div id="confirm-total-amount" class="ms-3 fs-5 text-success fw-bold"></div>
                        </div>
                        <div class="col-12">
                            <strong>รายการ:</strong>
                            <div id="confirm-items-list" class="ms-3"></div>
                        </div>
                    </div>
                </div>

                <!-- Warning Section -->
                <div class="alert alert-warning mb-4">
                    <h6 class="fw-bold mb-2">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        คำเตือนสำคัญ
                    </h6>
                    <ul class="mb-0">
                        <li>เมื่อบันทึกเป็น <strong>"เสร็จสิ้น"</strong> แล้ว <strong class="text-danger">ไม่สามารถแก้ไขได้โดยตรง</strong></li>
                        <li>หากต้องการแก้ไข จะต้อง <strong>ส่งคำขอแก้ไข</strong> และรอการอนุมัติจากผู้จัดการ</li>
                        <li>กรุณาตรวจสอบข้อมูลให้ถูกต้องก่อนยืนยัน</li>
                    </ul>
                </div>

                <!-- Preview PDF Link -->
                <div class="text-center mb-3">
                    <button type="button" class="btn btn-outline-primary" onclick="openPreviewPDF()">
                        <i class="fas fa-file-pdf me-2"></i>
                        ดูตัวอย่าง PDF ก่อนบันทึก (แนะนำ)
                    </button>
                </div>

                <!-- Confirmation Checkbox -->
                <div class="form-check p-3 bg-light rounded">
                    <input class="form-check-input" type="checkbox" id="confirmCheckbox" onchange="toggleConfirmButton()">
                    <label class="form-check-label fw-bold" for="confirmCheckbox">
                        ข้าพเจ้าได้ตรวจสอบข้อมูลถูกต้องครบถ้วนแล้ว และยอมรับว่าหากต้องการแก้ไขจะต้องขออนุมัติ
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    ยกเลิก
                </button>
                <button type="button" class="btn btn-success" id="confirmCompleteBtn" onclick="confirmComplete()" disabled>
                    <i class="fas fa-check-circle me-2"></i>
                    ยืนยันบันทึกใบสำคัญ
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let itemCounter = 0;
let savedReceiptId = null;
let currentTemplate = null;

// Handle template selection change
function handleTemplateChange() {
    const select = document.getElementById('template-select');
    const container = document.getElementById('dynamic-fields-container');

    if (!select.value) {
        container.innerHTML = '';
        currentTemplate = null;
        return;
    }

    const option = select.selectedOptions[0];

    // Parse sub_items safely
    let subItems = {};
    try {
        const subItemsStr = option.dataset.subItems;
        console.log('Raw sub_items data:', subItemsStr);

        if (subItemsStr && subItemsStr !== 'null' && subItemsStr !== 'None') {
            subItems = JSON.parse(subItemsStr);
        }
        console.log('Parsed sub_items:', subItems);
    } catch (e) {
        console.error('Error parsing sub_items:', e);
        console.error('Data was:', option.dataset.subItems);
        subItems = {};
    }

    currentTemplate = {
        id: select.value,
        name: option.dataset.name,
        inputType: option.dataset.inputType,
        maxAmount: parseFloat(option.dataset.maxAmount) || 0,
        subItems: subItems
    };

    console.log('Current template:', currentTemplate);

    // Clear previous fields
    container.innerHTML = '';

    // Render fields based on input type
    if (currentTemplate.inputType === 'simple') {
        renderSimpleInput(container);
    } else if (currentTemplate.inputType === 'textarea') {
        renderTextareaInput(container);
    } else if (currentTemplate.inputType === 'food_calculation') {
        renderFoodCalculationInput(container);
    }
}

// Render simple amount input (e.g., ค่าประกันของเสียหาย)
function renderSimpleInput(container) {
    const maxAmount = currentTemplate.maxAmount;
    const templateName = currentTemplate.name;
    const maxAmountText = maxAmount > 0 ? ` (สูงสุดไม่เกิน ${maxAmount.toLocaleString()} บาท)` : '';
    const defaultAmount = maxAmount > 0 ? maxAmount : 0;

    const html = `
        <div class="row g-2">
            <div class="col-md-8">
                <label class="form-label fw-bold mb-1 small">รายละเอียด</label>
                <input type="text" class="form-control form-control-sm" id="simple-description"
                       value="${templateName}${maxAmountText}" readonly>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold mb-1 small">จำนวนเงิน</label>
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control" id="simple-amount"
                           step="0.01" min="0" max="${maxAmount}" value="${defaultAmount}" placeholder="0.00">
                    <span class="input-group-text">บาท</span>
                </div>
                ${maxAmount > 0 ? `<div class="form-text text-warning small">สูงสุด ${maxAmount.toLocaleString()} บาท</div>` : ''}
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-success btn-sm w-100" onclick="addSimpleItem()">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
    `;
    container.innerHTML = html;
}

// Render textarea + amount input (e.g., รับเงินอื่นๆ)
function renderTextareaInput(container) {
    const html = `
        <div class="row g-2">
            <div class="col-md-8">
                <label class="form-label fw-bold mb-1 small">รายละเอียด</label>
                <textarea class="form-control form-control-sm" id="textarea-description" rows="3"
                          placeholder="กรอกรายละเอียด..."></textarea>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold mb-1 small">จำนวนเงิน</label>
                <div class="input-group input-group-sm">
                    <input type="number" class="form-control" id="textarea-amount"
                           step="0.01" min="0" placeholder="0.00">
                    <span class="input-group-text">บาท</span>
                </div>
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-success btn-sm w-100" onclick="addTextareaItem()">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
    `;
    container.innerHTML = html;
}

// Render food calculation input with multiple sub-items
function renderFoodCalculationInput(container) {
    const items = currentTemplate.subItems.items || [];
    const maxAmount = currentTemplate.maxAmount;

    let html = '<div id="food-items-wrapper">';

    items.forEach((item, index) => {
        html += `
            <div class="food-item-group mb-3 p-3 border rounded" id="food-item-${item.id}">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold mb-0">${item.label}</h6>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFoodItem('${item.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="row g-2">
                    <div class="col-md-3">
                        <label class="form-label small">จำนวนมื้อ</label>
                        <input type="number" class="form-control form-control-sm food-meals"
                               id="${item.id}-meals" min="0" step="1" value="0"
                               onchange="calculateFoodTotal()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">มื้อละ (บาท)</label>
                        <input type="number" class="form-control form-control-sm food-price"
                               id="${item.id}-price" min="0" step="0.01" value="0"
                               onchange="calculateFoodTotal()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">จำนวนคน</label>
                        <input type="number" class="form-control form-control-sm food-people"
                               id="${item.id}-people" min="0" step="1" value="0"
                               onchange="calculateFoodTotal()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">วันที่</label>
                        <input type="date" class="form-control form-control-sm food-date"
                               id="${item.id}-date">
                    </div>
                    <div class="col-12">
                        <div class="text-end">
                            <strong>รวม: </strong>
                            <span id="${item.id}-total" class="text-success fw-bold">0.00 บาท</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    html += `
        <div class="alert alert-info mb-2">
            <strong>รวมทั้งหมด: </strong>
            <span id="food-grand-total" class="fs-5 fw-bold">0.00 บาท</span>
            ${maxAmount > 0 ? `<span class="text-muted ms-2">(สูงสุด ${maxAmount.toLocaleString()} บาท)</span>` : ''}
        </div>
        <div class="text-end">
            <button type="button" class="btn btn-success" onclick="addFoodItems()">
                <i class="fas fa-check me-1"></i>เพิ่มรายการทั้งหมด
            </button>
        </div>
    `;

    container.innerHTML = html;
}

// Add simple item
function addSimpleItem() {
    const description = document.getElementById('simple-description').value.trim();
    const amount = parseFloat(document.getElementById('simple-amount').value) || 0;

    if (!description) {
        alert('กรุณากรอกรายละเอียด');
        return;
    }

    if (amount <= 0) {
        alert('กรุณากรอกจำนวนเงิน');
        return;
    }

    if (currentTemplate.maxAmount > 0 && amount > currentTemplate.maxAmount) {
        alert(`จำนวนเงินเกิน ${currentTemplate.maxAmount.toLocaleString()} บาท`);
        return;
    }

    addItemToList(description, amount);

    // Clear and reset
    document.getElementById('template-select').value = '';
    document.getElementById('dynamic-fields-container').innerHTML = '';
    currentTemplate = null;
}

// Add textarea item
function addTextareaItem() {
    const description = document.getElementById('textarea-description').value.trim();
    const amount = parseFloat(document.getElementById('textarea-amount').value) || 0;

    if (!description) {
        alert('กรุณากรอกรายละเอียด');
        return;
    }

    if (amount <= 0) {
        alert('กรุณากรอกจำนวนเงิน');
        return;
    }

    addItemToList(description, amount);

    // Clear inputs
    document.getElementById('textarea-description').value = '';
    document.getElementById('textarea-amount').value = '';
}

// Calculate food item total
function calculateFoodTotal() {
    const items = currentTemplate.subItems.items || [];
    let grandTotal = 0;

    items.forEach(item => {
        const meals = parseFloat(document.getElementById(`${item.id}-meals`)?.value) || 0;
        const price = parseFloat(document.getElementById(`${item.id}-price`)?.value) || 0;
        const people = parseFloat(document.getElementById(`${item.id}-people`)?.value) || 0;

        const total = meals * price * people;
        grandTotal += total;

        const totalElement = document.getElementById(`${item.id}-total`);
        if (totalElement) {
            totalElement.textContent = total.toLocaleString('th-TH', {minimumFractionDigits: 2}) + ' บาท';
        }
    });

    const grandTotalElement = document.getElementById('food-grand-total');
    if (grandTotalElement) {
        grandTotalElement.textContent = grandTotal.toLocaleString('th-TH', {minimumFractionDigits: 2}) + ' บาท';

        // Check max amount
        if (currentTemplate.maxAmount > 0 && grandTotal > currentTemplate.maxAmount) {
            grandTotalElement.classList.add('text-danger');
            grandTotalElement.classList.remove('text-success');
        } else {
            grandTotalElement.classList.add('text-success');
            grandTotalElement.classList.remove('text-danger');
        }
    }

    return grandTotal;
}

// Remove food item
function removeFoodItem(itemId) {
    const element = document.getElementById(`food-item-${itemId}`);
    if (element) {
        element.remove();
        calculateFoodTotal();
    }
}

// Convert date to Thai format
function convertDateToThai(dateString) {
    if (!dateString) return '';

    const thaiMonths = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                        'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];

    const date = new Date(dateString);
    const day = date.getDate();
    const month = thaiMonths[date.getMonth()];
    const year = date.getFullYear() + 543;

    return `${day} ${month} ${year}`;
}

// Add all food items to list
function addFoodItems() {
    const items = currentTemplate.subItems.items || [];
    const grandTotal = calculateFoodTotal();

    if (grandTotal <= 0) {
        alert('กรุณากรอกข้อมูลอย่างน้อย 1 รายการ');
        return;
    }

    if (currentTemplate.maxAmount > 0 && grandTotal > currentTemplate.maxAmount) {
        alert(`จำนวนเงินรวมเกิน ${currentTemplate.maxAmount.toLocaleString()} บาท`);
        return;
    }

    // Add each food item separately
    items.forEach(item => {
        const itemElement = document.getElementById(`food-item-${item.id}`);
        if (!itemElement) return; // Skip if deleted

        const meals = parseFloat(document.getElementById(`${item.id}-meals`)?.value) || 0;
        const price = parseFloat(document.getElementById(`${item.id}-price`)?.value) || 0;
        const people = parseFloat(document.getElementById(`${item.id}-people`)?.value) || 0;
        const date = document.getElementById(`${item.id}-date`)?.value || '';

        const total = meals * price * people;

        if (total > 0) {
            const thaiDate = date ? convertDateToThai(date) : '';
            const description = `${item.name} ${meals} มื้อ × ${price} บาท × ${people} คน${thaiDate ? ' (' + thaiDate + ')' : ''}`;
            addItemToList(description, total);
        }
    });

    // Clear and reset
    document.getElementById('template-select').value = '';
    document.getElementById('dynamic-fields-container').innerHTML = '';
    currentTemplate = null;
}

// Common function to add item to list
function addItemToList(description, amount) {
    itemCounter++;
    const container = document.getElementById('items-container');
    
    // Remove empty message if it exists
    const emptyMessage = container.querySelector('.text-center');
    if (emptyMessage) {
        emptyMessage.remove();
    }
    
    // Replace newlines with <br> for display
    const displayDescription = description.replace(/\n/g, '<br>');
    
    const itemHtml = `
        <div class="item-row border rounded p-3 mb-3" data-item-id="${itemCounter}">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="fw-bold mb-1">${displayDescription}</div>
                    <div class="text-muted">จำนวนเงิน: <span class="fw-bold">${amount.toLocaleString()}</span> บาท</div>
                    <input type="hidden" class="item-description-hidden" value="${description}">
                    <input type="hidden" class="item-amount-hidden" value="${amount}">
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(${itemCounter})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', itemHtml);
    calculateTotal();
}

// Remove item
function removeItem(itemId) {
    const item = document.querySelector(`[data-item-id="${itemId}"]`);
    if (item) {
        item.remove();
        calculateTotal();
        
        // Show empty message if no items left
        const container = document.getElementById('items-container');
        if (container.children.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-list-alt fa-2x mb-2"></i>
                    <p>กรุณาเพิ่มรายการรับเงิน</p>
                </div>
            `;
        }
    }
}


// Calculate total amount
function calculateTotal() {
    let total = 0;
    let itemCount = 0;
    
    // Use the hidden input fields to calculate total
    document.querySelectorAll('.item-amount-hidden').forEach(input => {
        const value = parseFloat(input.value) || 0;
        total += value;
        if (value > 0) itemCount++;
    });
    
    // Format number with commas for Thai display
    const formattedTotal = formatNumber(total);
    
    const totalField = document.getElementById('total_amount');  // hidden field
    const totalDisplayField = document.getElementById('total_amount_display');  // display field
    const totalTextField = document.getElementById('total_amount_text');
    
    // อัปเดต hidden field ด้วยค่าตัวเลขล้วนๆ
    if (totalField) {
        totalField.value = total;
    }
    
    // อัปเดต display field ด้วยค่าที่มีจุลภาค
    if (totalDisplayField) {
        totalDisplayField.value = formattedTotal;
        console.log('Set display total field value to:', totalDisplayField.value);
    } else {
        console.error('total_amount_display field not found!');
    }
    
    if (totalTextField) {
        totalTextField.value = convertToThaiText(total);
    } else {
        console.error('total_amount_text field not found!');
    }
    
    updatePreview();
}

// Format number with commas
function formatNumber(num) {
    if (num === null || num === undefined || num === '') return '0.00';
    
    // แปลงเป็นตัวเลขก่อน
    const number = Number(num);
    if (isNaN(number)) return '0.00';
    
    // แบบง่ายๆ ไม่ใช้ regex
    const str = number.toFixed(2);
    const parts = str.split('.');
    const integerPart = parts[0];
    const decimalPart = parts[1];
    
    // เพิ่มจุลภาคทีละ 3 หลัก
    let formatted = '';
    for (let i = integerPart.length - 1, count = 0; i >= 0; i--, count++) {
        if (count > 0 && count % 3 === 0) {
            formatted = ',' + formatted;
        }
        formatted = integerPart[i] + formatted;
    }
    
    return formatted + '.' + decimalPart;
}

// Convert number to Thai text
function convertToThaiText(amount) {
    // ตรวจสอบ input ก่อน
    if (!amount || isNaN(amount) || amount <= 0) return 'ศูนย์บาทถ้วน';
    
    const ones = ['', 'หนึ่ง', 'สอง', 'สาม', 'สี่', 'ห้า', 'หก', 'เจ็ด', 'แปด', 'เก้า'];
    const units = ['', 'สิบ', 'ร้อย', 'พัน', 'หมื่น', 'แสน', 'ล้าน', 'สิบล้าน', 'ร้อยล้าน', 'พันล้าน'];
    
    function convertIntegerPart(num) {
        if (!num || num === 0) return '';
        
        let result = '';
        let unitIndex = 0;
        
        while (num > 0) {
            let digit = num % 10;
            
            if (digit > 0) {
                let digitText = '';
                
                if (unitIndex === 1) { // หลักสิบ
                    if (digit === 1) {
                        digitText = 'สิบ';
                    } else if (digit === 2) {
                        digitText = 'ยี่สิบ';
                    } else {
                        digitText = ones[digit] + 'สิบ';
                    }
                } else { // หลักอื่นๆ
                    // กรณีพิเศษสำหรับ "หนึ่ง" ในหลักที่มากกว่าหลักหน่วย
                    if (digit === 1 && unitIndex > 1) {
                        // ถ้าเป็น "หนึ่ง" ในหลักร้อย, พัน, หมื่น, แสน ให้ใส่ "หนึ่ง"
                        // แต่ถ้าเป็นหลักล้านขึ้นไป และเป็นเลข 1 ในหลักสูงสุด ให้ไม่ใส่ "หนึ่ง"
                        if (unitIndex >= 6 && num < 10) { // ล้าน, สิบล้าน, ร้อยล้าน และเป็นหลักเดียว
                            digitText = units[unitIndex];
                        } else {
                            digitText = ones[digit] + units[unitIndex];
                        }
                    } else {
                        digitText = ones[digit];
                        if (unitIndex > 0 && units[unitIndex]) {
                            digitText += units[unitIndex];
                        }
                    }
                }
                
                result = digitText + result;
            }
            
            num = Math.floor(num / 10);
            unitIndex++;
        }
        
        return result;
    }
    
    // แปลงเป็น number และตรวจสอบ
    const numAmount = Number(amount);
    if (isNaN(numAmount)) return 'จำนวนเงินไม่ถูกต้อง';
    
    const integerPart = Math.floor(numAmount);
    const decimalPart = Math.round((numAmount - integerPart) * 100);
    
    let result = '';
    
    // ส่วนบาท
    const bahtText = convertIntegerPart(integerPart);
    result = (bahtText || 'ศูนย์') + 'บาท';
    
    // ส่วนสตางค์
    if (decimalPart > 0) {
        const satangText = convertIntegerPart(decimalPart);
        result += satangText + 'สตางค์';
    } else {
        result += 'ถ้วน';
    }
    
    return result;
}

// Update preview
function updatePreview() {
    // TODO: Implement real-time preview
    console.log('Preview updated');
}

// Form actions
function resetForm() {
    if (confirm('ต้องการเคลียร์ข้อมูลทั้งหมดหรือไม่?')) {
        document.getElementById('receiptForm').reset();
        document.getElementById('items-container').innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-list-alt fa-2x mb-2"></i>
                <p>กรุณาเพิ่มรายการรับเงิน</p>
            </div>
        `;
        calculateTotal();
    }
}

function saveDraft() {
    saveReceipt('draft');
}

// Show confirmation modal before completing
function showCompleteConfirmation() {
    // Validate form first
    const form = document.getElementById('receiptForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    // Check items
    const items = [];
    document.querySelectorAll('.item-row').forEach(row => {
        const description = row.querySelector('.item-description-hidden').value.trim();
        const amount = parseFloat(row.querySelector('.item-amount-hidden').value) || 0;

        if (description && amount > 0) {
            items.push({
                description: description,
                amount: amount
            });
        }
    });

    if (items.length === 0) {
        alert('กรุณาเพิ่มรายการรับเงิน');
        return;
    }

    // Populate modal with data
    document.getElementById('confirm-recipient-name').textContent = document.getElementById('recipient_name').value;
    document.getElementById('confirm-id-card').textContent = document.getElementById('recipient_id_card').value;

    const totalAmount = parseFloat(document.getElementById('total_amount').value || 0);
    document.getElementById('confirm-total-amount').textContent = totalAmount.toLocaleString('th-TH', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }) + ' บาท';

    // Show items list
    let itemsHTML = '<ul class="mb-0">';
    items.forEach((item, index) => {
        itemsHTML += `<li>${item.description}: ${item.amount.toLocaleString('th-TH', {minimumFractionDigits: 2})} บาท</li>`;
    });
    itemsHTML += '</ul>';
    document.getElementById('confirm-items-list').innerHTML = itemsHTML;

    // Reset checkbox
    document.getElementById('confirmCheckbox').checked = false;
    document.getElementById('confirmCompleteBtn').disabled = true;

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('completeConfirmationModal'));
    modal.show();
}

// Toggle confirm button based on checkbox
function toggleConfirmButton() {
    const checkbox = document.getElementById('confirmCheckbox');
    const confirmBtn = document.getElementById('confirmCompleteBtn');
    confirmBtn.disabled = !checkbox.checked;
}

// Open preview PDF in new window (if receipt already saved as draft)
function openPreviewPDF() {
    if (savedReceiptId) {
        window.open(`/accounts/receipt/${savedReceiptId}/pdf/`, '_blank');
    } else {
        alert('กรุณาบันทึกร่างก่อนเพื่อดูตัวอย่าง PDF หรือยืนยันบันทึกเพื่อดู PDF ภายหลัง');
    }
}

// Confirm and complete receipt
function confirmComplete() {
    // Hide modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('completeConfirmationModal'));
    modal.hide();

    // Save as completed
    saveReceipt('completed');
}

// Legacy function (kept for backward compatibility)
function saveAndPreview() {
    showCompleteConfirmation();
}

function saveReceipt(status) {
    // Validate form
    const form = document.getElementById('receiptForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Check items
    const items = [];
    document.querySelectorAll('.item-row').forEach(row => {
        const description = row.querySelector('.item-description-hidden').value.trim();
        const amount = parseFloat(row.querySelector('.item-amount-hidden').value) || 0;
        
        if (description && amount > 0) {
            items.push({
                description: description,
                amount: amount
            });
        }
    });
    
    if (items.length === 0) {
        alert('กรุณาเพิ่มรายการรับเงิน');
        return;
    }
    
    // Prepare data
    const data = {
        recipient_name: document.getElementById('recipient_name').value,
        recipient_address: document.getElementById('recipient_address').value,
        recipient_postal_code: document.getElementById('recipient_postal_code').value,
        recipient_id_card: document.getElementById('recipient_id_card').value,
        receipt_date: document.getElementById('receipt_date').value,
        is_loan: document.querySelector('input[name="is_loan"]:checked').value === 'true',
        total_amount: parseFloat(document.getElementById('total_amount').value || 0),
        status: status,
        items: items
    };
    
    // Show loading - หาปุ่มที่ถูกต้อง
    let submitBtn;
    if (status === 'draft') {
        submitBtn = document.querySelector('button[onclick="saveDraft()"]');
    } else {
        submitBtn = document.querySelector('button[onclick="saveAndPreview()"]');
    }
    
    if (submitBtn) {
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังบันทึก...';
        submitBtn.disabled = true;
        
        // เก็บ reference เพื่อใช้ใน finally
        window.tempSubmitBtn = submitBtn;
        window.tempOriginalText = originalText;
    }
    
    // Send AJAX request
    fetch('/accounts/receipt/save/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            savedReceiptId = data.receipt_id;

            // Show success toast
            const receiptNumberText = data.receipt_number ? `เลขที่: ${data.receipt_number}` : '(ร่าง - ยังไม่มีเลข)';
            showToast('success', 'บันทึกสำเร็จ!', `${receiptNumberText}<br><small class="text-muted">กำลังนำไปยังหน้ารายละเอียด...</small>`);

            // Auto redirect to receipt detail page after 2 seconds
            setTimeout(() => {
                window.location.href = `/receipt/${data.receipt_id}/`;
            }, 2000);
        } else {
            showToast('error', 'เกิดข้อผิดพลาด', data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'เกิดข้อผิดพลาด', 'ไม่สามารถบันทึกข้อมูลได้ กรุณาลองใหม่อีกครั้ง');
    })
    .finally(() => {
        if (window.tempSubmitBtn) {
            window.tempSubmitBtn.innerHTML = window.tempOriginalText;
            window.tempSubmitBtn.disabled = false;
            window.tempSubmitBtn = null;
            window.tempOriginalText = null;
        }
    });
}

// Toast notification function
function showToast(type, title, message) {
    const toastId = 'toast-' + Date.now();
    const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';

    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <div class="d-flex align-items-start">
                        <i class="fas ${iconClass} fa-lg me-3 mt-1"></i>
                        <div>
                            <strong>${title}</strong><br>
                            ${message}
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;

    const container = document.getElementById('toastContainer');
    container.insertAdjacentHTML('beforeend', toastHtml);

    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: 4000 // 4 seconds
    });

    toast.show();

    // Remove from DOM after hidden
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}


// Test function - ลบออกหลังจากแก้ไขเสร็จ
function testCalculateTotal() {
    console.log('=== Testing calculateTotal function ===');
    
    // ทดสอบ formatNumber
    console.log('formatNumber(2000):', formatNumber(2000));
    console.log('formatNumber(20000):', formatNumber(20000));
    
    // ทดสอบ calculateTotal
    calculateTotal();
    
    console.log('=== End test ===');
}

// เรียกทดสอบเมื่อโหลดหน้า
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, testing...');
    
    // ทดสอบหา element
    const totalField = document.getElementById('total_amount');
    const totalDisplayField = document.getElementById('total_amount_display');
    const totalTextField = document.getElementById('total_amount_text');
    
    console.log('total_amount hidden field:', totalField);
    console.log('total_amount_display field:', totalDisplayField);
    console.log('total_amount_text field:', totalTextField);
    
    // ทดสอบ formatNumber
    console.log('formatNumber test:', formatNumber(2000));
});

// Initialize receipt date field
function initializeReceiptDateField() {
    const receiptDateInput = document.getElementById('receipt_date');
    const receiptDateHelp = document.getElementById('receipt_date_help');

    if (!receiptDateInput) return;

    // ตั้งค่าวันที่ปัจจุบันเป็น default
    const today = new Date();
    const formattedToday = today.toISOString().split('T')[0];
    receiptDateInput.value = formattedToday;

    // คำนวณปีงบประมาณปัจจุบัน (1 ตุลาคม)
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth(); // 0-11

    let fiscalYearStart;
    if (currentMonth >= 9) { // ตุลาคม (เดือน 9) ขึ้นไป
        // อยู่ในปีงบประมาณใหม่ เริ่ม 1 ตุลาคม ปีนี้
        fiscalYearStart = new Date(currentYear, 9, 1); // October 1
    } else {
        // อยู่ในปีงบประมาณเดิม เริ่ม 1 ตุลาคม ปีที่แล้ว
        fiscalYearStart = new Date(currentYear - 1, 9, 1);
    }

    // แปลงเป็น YYYY-MM-DD สำหรับ input[type="date"]
    const minDate = fiscalYearStart.toISOString().split('T')[0];
    const maxDate = formattedToday; // ไม่เกินวันนี้

    // ตั้งค่า min และ max
    receiptDateInput.setAttribute('min', minDate);
    receiptDateInput.setAttribute('max', maxDate);

    // แสดงข้อความช่วยเหลือ
    const minDateThai = formatDateThai(fiscalYearStart);
    const maxDateThai = formatDateThai(today);
    receiptDateHelp.textContent = `ย้อนหลังได้ตั้งแต่ ${minDateThai} ถึง ${maxDateThai} (ห้ามกำหนดล่วงหน้า)`;
    receiptDateHelp.className = 'form-text text-primary';

    // เพิ่ม event listener เพื่อ validate
    receiptDateInput.addEventListener('change', function() {
        validateReceiptDate(this, minDate, maxDate, fiscalYearStart, today);
    });
}

function formatDateThai(date) {
    const thaiMonths = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
    const day = date.getDate();
    const month = thaiMonths[date.getMonth()];
    const yearBE = date.getFullYear() + 543;
    return `${day} ${month} ${yearBE}`;
}

function validateReceiptDate(input, minDate, maxDate, minDateObj, maxDateObj) {
    const selectedDate = new Date(input.value);
    const receiptDateHelp = document.getElementById('receipt_date_help');

    if (input.value < minDate) {
        input.setCustomValidity(`วันที่ต้องไม่ก่อน ${formatDateThai(minDateObj)} (ต้นปีงบประมาณ)`);
        receiptDateHelp.textContent = `❌ วันที่ต้องไม่ก่อน ${formatDateThai(minDateObj)}`;
        receiptDateHelp.className = 'form-text text-danger';
        input.classList.add('is-invalid');
        return false;
    } else if (input.value > maxDate) {
        input.setCustomValidity('ไม่สามารถกำหนดวันที่ล่วงหน้าได้');
        receiptDateHelp.textContent = '❌ ไม่สามารถกำหนดวันที่ล่วงหน้าได้';
        receiptDateHelp.className = 'form-text text-danger';
        input.classList.add('is-invalid');
        return false;
    } else {
        input.setCustomValidity('');
        const minDateThai = formatDateThai(minDateObj);
        const maxDateThai = formatDateThai(maxDateObj);
        receiptDateHelp.textContent = `✓ ย้อนหลังได้ตั้งแต่ ${minDateThai} ถึง ${maxDateThai}`;
        receiptDateHelp.className = 'form-text text-success';
        input.classList.remove('is-invalid');
        return true;
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Initialize total calculation
    calculateTotal();

    // Initialize receipt date field
    initializeReceiptDateField();
});
</script>

<style>
/* Food calculation item styling */
.food-item-group {
    background-color: #f9fafb;
    border: 1px solid #e5e7eb !important;
    transition: all 0.2s ease;
}

.food-item-group:hover {
    border-color: #CFAE43 !important;
    box-shadow: 0 2px 8px rgba(207, 174, 67, 0.2);
}

/* Item styling */
.item-row {
    background-color: #fff;
    transition: all 0.2s ease;
    border: 1px solid #e5e7eb !important;
}

.item-row:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border-color: #CFAE43 !important;
}

/* Form styling */
.tab-content {
    padding-top: 20px;
}

.form-control:focus {
    border-color: #CFAE43;
    box-shadow: 0 0 0 0.2rem rgba(207, 174, 67, 0.25);
}

.btn-success {
    background-color: #CFAE43;
    border-color: #CFAE43;
}

.btn-success:hover {
    background-color: #b8951a;
    border-color: #b8951a;
}

.sticky-top {
    position: sticky !important;
}

/* Toast Styling */
.toast {
    min-width: 350px;
    max-width: 400px;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    margin-left: auto;
}

.toast-body {
    padding: 1rem;
    color: white !important;
}

.toast-body * {
    color: white !important;
}

.toast-body small {
    opacity: 0.9;
}

.toast .btn-close-white {
    filter: brightness(1) invert(0);
}

#toastContainer {
    max-width: 420px;
}

/* Animation */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.toast.show {
    animation: slideInRight 0.3s ease-out;
}
</style>

<!-- jQuery (included for Bootstrap compatibility) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}