{% extends 'base_sidebar.html' %}
{% load humanize %}
{% load static %}

{% block title %}{{ title }} - ระบบออกใบสำคัญรับเงิน{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{% block extra_css %}
<!-- Custom CSS -->
{% endblock %}

{% block content %}
<!-- Toast Container -->
<div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 9999; right: 0;"></div>

<!-- Header Card -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);">
            <div class="card-body text-white py-2 px-3">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="mb-0 fw-bold">
                            <i class="fas fa-edit me-2"></i>
                            แก้ไขใบสำคัญรับเงิน (ร่าง)
                        </h6>
                        <small class="opacity-90">
                            <i class="fas fa-building me-1"></i>
                            {{ department.name }} ({{ department.code }})
                        </small>
                        <br>
                        <small class="opacity-75">
                            <i class="fas fa-file-alt me-1"></i>
                            เลขที่: {% if receipt.receipt_number %}{{ receipt.receipt_number }}{% else %}(ยังไม่มีเลข){% endif %}
                        </small>
                    </div>
                    <i class="fas fa-file-edit" style="font-size: 2rem; opacity: 0.3;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Receipt Form -->
<div class="row">
    <!-- Form Section (Full Width) -->
    <div class="col-12">
        <form id="receiptForm">
            {% csrf_token %}
            
            <!-- Recipient Information -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-white border-0 py-2">
                    <h6 class="mb-0 fw-bold" style="color: #CFAE43; font-size: 0.95rem;">
                        <i class="fas fa-user me-2"></i>
                        ข้อมูลผู้รับเงิน
                    </h6>
                </div>
                <div class="card-body py-3">
                    <div class="row g-2">
                        <div class="col-md-12">
                            <label for="recipient_name" class="form-label fw-bold mb-1 small">ชื่อผู้รับเงิน <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="recipient_name" name="recipient_name"
                                   value="{{ receipt.recipient_name }}" required placeholder="ข้าพเจ้า...">
                        </div>
                        <div class="col-md-12">
                            <label for="recipient_address" class="form-label fw-bold mb-1 small">ที่อยู่ <span class="text-danger">*</span></label>
                            <textarea class="form-control form-control-sm" id="recipient_address" name="recipient_address" rows="2" required placeholder="บ้านเลขที่ หมู่ ซอย ถนน ตำบล อำเภอ จังหวัด">{{ receipt.recipient_address }}</textarea>
                        </div>
                        <div class="col-md-4">
                            <label for="recipient_postal_code" class="form-label fw-bold mb-1 small">รหัสไปรษณีย์</label>
                            <input type="text" class="form-control form-control-sm" id="recipient_postal_code" name="recipient_postal_code"
                                   pattern="[0-9]{5}" maxlength="5" value="{{ receipt.recipient_postal_code }}" placeholder="5 หลัก">
                        </div>
                        <div class="col-md-4">
                            <label for="recipient_id_card" class="form-label fw-bold mb-1 small">เลขบัตรประชาชน <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="recipient_id_card" name="recipient_id_card"
                                   pattern="[0-9]{13}" maxlength="13" value="{{ receipt.recipient_id_card }}" required placeholder="13 หลัก">
                        </div>
                        <div class="col-md-4">
                            <label for="receipt_date" class="form-label fw-bold mb-1 small">วันที่ออกใบสำคัญ <span class="text-danger">*</span></label>
                            <input type="date" class="form-control form-control-sm" id="receipt_date" name="receipt_date"
                                   value="{{ receipt.receipt_date|date:'Y-m-d' }}" required>
                            <div class="form-text small" id="receipt_date_help" style="font-size: 0.7rem;">ย้อนหลังได้ถึงต้นปีงบฯ</div>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold mb-1 small">ประเภทการจ่าย</label>
                            <div class="d-flex gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="is_loan" id="is_loan_false" value="false"
                                           {% if not receipt.is_loan %}checked{% endif %}>
                                    <label class="form-check-label small" for="is_loan_false">
                                        <i class="fas fa-hand-holding-usd me-1"></i>
                                        จ่ายปกติ
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="is_loan" id="is_loan_true" value="true"
                                           {% if receipt.is_loan %}checked{% endif %}>
                                    <label class="form-check-label small" for="is_loan_true">
                                        <i class="fas fa-handshake me-1"></i>
                                        ยืมเงิน (ใช้ชื่อ {{ user_full_name }} เป็นผู้จ่าย)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Receipt Items -->
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-white border-0 py-2">
                    <h6 class="mb-0 fw-bold" style="color: #CFAE43; font-size: 0.95rem;">
                        <i class="fas fa-list me-2"></i>
                        รายการรับเงิน
                    </h6>
                </div>
                <div class="card-body py-3">
                    <!-- Items List -->
                    <div>
                        <h6 class="fw-bold mb-2 small">รายการที่เพิ่มแล้ว</h6>
                    <div id="items-container">
                        <!-- Items will be loaded from existing receipt -->
                    </div>

                    <!-- Total Amount Display -->
                    <div class="row mt-3 pt-2 border-top">
                        <div class="col-md-6">
                            <label class="form-label fw-bold mb-1 small">จำนวนเงินรวม (ตัวเลข)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="total_amount_display" readonly
                                       style="font-size: 1.1rem; font-weight: bold; text-align: right;">
                                <span class="input-group-text">บาท</span>
                            </div>
                            <!-- Hidden field สำหรับเก็บค่าตัวเลขจริง -->
                            <input type="hidden" id="total_amount" name="total_amount">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold mb-1 small">จำนวนเงิน (ตัวหนังสือ)</label>
                            <input type="text" class="form-control" id="total_amount_text" readonly
                                   style="font-family: 'Sarabun', sans-serif;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row">
                <div class="col-12">
                    <div class="d-flex gap-2 justify-content-end align-items-center">
                        <a href="{% url 'receipt_detail' receipt.id %}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-arrow-left me-1"></i>
                            ยกเลิก
                        </a>
                        <button type="button" class="btn btn-warning btn-sm" onclick="updateDraft()">
                            <i class="fas fa-save me-1"></i>
                            บันทึกร่าง
                        </button>
                        <button type="button" class="btn btn-success px-4" onclick="showCompleteConfirmation()">
                            <i class="fas fa-check-circle me-2"></i>
                            บันทึกใบสำคัญ
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Complete Confirmation Modal -->
<div class="modal fade" id="completeConfirmationModal" tabindex="-1" aria-labelledby="completeConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="completeConfirmationModalLabel">
                    <i class="fas fa-check-circle me-2"></i>
                    ยืนยันการบันทึกใบสำคัญรับเงิน
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Summary Section -->
                <div class="alert alert-info mb-4">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        สรุปข้อมูลใบสำคัญรับเงิน
                    </h6>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <strong>ชื่อผู้รับเงิน:</strong>
                            <div id="confirm-recipient-name" class="ms-3"></div>
                        </div>
                        <div class="col-md-6">
                            <strong>เลขบัตรประชาชน:</strong>
                            <div id="confirm-id-card" class="ms-3 font-monospace"></div>
                        </div>
                        <div class="col-12">
                            <strong>จำนวนเงินรวม:</strong>
                            <div id="confirm-total-amount" class="ms-3 fs-5 text-success fw-bold"></div>
                        </div>
                        <div class="col-12">
                            <strong>รายการ:</strong>
                            <div id="confirm-items-list" class="ms-3"></div>
                        </div>
                    </div>
                </div>

                <!-- Warning Section -->
                <div class="alert alert-warning mb-4">
                    <h6 class="fw-bold mb-2">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        คำเตือนสำคัญ
                    </h6>
                    <ul class="mb-0">
                        <li>เมื่อบันทึกเป็น <strong>"เสร็จสิ้น"</strong> แล้ว <strong class="text-danger">ไม่สามารถแก้ไขได้โดยตรง</strong></li>
                        <li>หากต้องการแก้ไข จะต้อง <strong>ส่งคำขอแก้ไข</strong> และรอการอนุมัติจากผู้จัดการ</li>
                        <li>กรุณาตรวจสอบข้อมูลให้ถูกต้องก่อนยืนยัน</li>
                    </ul>
                </div>

                <!-- Preview PDF Link -->
                <div class="text-center mb-3">
                    <button type="button" class="btn btn-outline-primary" onclick="openPreviewPDF()">
                        <i class="fas fa-file-pdf me-2"></i>
                        ดูตัวอย่าง PDF ก่อนบันทึก (แนะนำ)
                    </button>
                </div>

                <!-- Confirmation Checkbox -->
                <div class="form-check p-3 bg-light rounded">
                    <input class="form-check-input" type="checkbox" id="confirmCheckbox" onchange="toggleConfirmButton()">
                    <label class="form-check-label fw-bold" for="confirmCheckbox">
                        ข้าพเจ้าได้ตรวจสอบข้อมูลถูกต้องครบถ้วนแล้ว และยอมรับว่าหากต้องการแก้ไขจะต้องขออนุมัติ
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    ยกเลิก
                </button>
                <button type="button" class="btn btn-success" id="confirmCompleteBtn" onclick="confirmComplete()" disabled>
                    <i class="fas fa-check-circle me-2"></i>
                    ยืนยันบันทึกใบสำคัญ
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let itemCounter = 0;
let savedReceiptId = {{ receipt.id }};

// Load existing items on page load
document.addEventListener('DOMContentLoaded', function() {
    loadExistingItems();
    calculateTotal();
    initializeReceiptDateField();
});

// Load existing receipt items
function loadExistingItems() {
    const container = document.getElementById('items-container');
    container.innerHTML = ''; // Clear container
    
    // Load items from server data
    const existingItems = [
        {% for item in receipt_items %}
        {
            id: {{ item.id }},
            description: `{{ item.description|escapejs }}`,
            amount: {{ item.amount }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    if (existingItems.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-list-alt fa-2x mb-2"></i>
                <p>กรุณาเพิ่มรายการรับเงิน</p>
            </div>
        `;
        return;
    }
    
    existingItems.forEach((item, index) => {
        itemCounter++;

        // Convert HTML to display text with line breaks preserved
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = item.description;

        // Replace block elements with newlines before getting text
        tempDiv.querySelectorAll('p, div, br').forEach(el => {
            if (el.tagName === 'BR') {
                el.replaceWith('\n');
            } else {
                el.insertAdjacentText('afterend', '\n');
            }
        });

        const plainText = (tempDiv.textContent || tempDiv.innerText || '').trim();
        const displayDescription = plainText.replace(/\n/g, '<br>');

        // Escape HTML for use in textarea value attribute
        const escapedDescription = item.description.replace(/"/g, '&quot;');

        const itemHtml = `
            <div class="item-row border rounded p-2 mb-2" data-item-id="${itemCounter}">
                <!-- Display Mode -->
                <div class="item-display-mode">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="item-description-display mb-1">${displayDescription}</div>
                            <div class="text-muted">จำนวนเงิน: <span class="item-amount-display fw-bold">${item.amount.toLocaleString()}</span> บาท</div>
                            <input type="hidden" class="item-description-hidden" value="${escapedDescription}">
                            <input type="hidden" class="item-amount-hidden" value="${item.amount}">
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-success" onclick="window.open('/accounts/receipt/${savedReceiptId}/pdf/', '_blank')" title="ดู PDF">
                                <i class="fas fa-file-pdf"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="editItem(${itemCounter})" title="แก้ไข">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(${itemCounter})" title="ลบ">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Edit Mode (hidden by default) -->
                <div class="item-edit-mode" style="display: none;">
                    <div class="mb-3">
                        <label class="form-label fw-bold small">รายการ</label>
                        <textarea class="form-control form-control-sm item-description-edit" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold small">จำนวนเงิน (บาท)</label>
                        <input type="number" class="form-control form-control-sm item-amount-edit" step="0.01" value="${item.amount}">
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-success" onclick="saveItem(${itemCounter})">
                            <i class="fas fa-save me-1"></i> บันทึก
                        </button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="cancelEdit(${itemCounter})">
                            <i class="fas fa-times me-1"></i> ยกเลิก
                        </button>
                    </div>
                </div>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', itemHtml);
    });
}

// Common function to add item to list (not used in edit page, kept for compatibility)
function addItemToList(description, amount) {
    itemCounter++;
    const container = document.getElementById('items-container');

    // Remove empty message if it exists
    const emptyMessage = container.querySelector('.text-center');
    if (emptyMessage) {
        emptyMessage.remove();
    }

    // Convert HTML to display text with line breaks preserved
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = description;

    // Replace block elements with newlines before getting text
    tempDiv.querySelectorAll('p, div, br').forEach(el => {
        if (el.tagName === 'BR') {
            el.replaceWith('\n');
        } else {
            el.insertAdjacentText('afterend', '\n');
        }
    });

    const plainText = (tempDiv.textContent || tempDiv.innerText || '').trim();
    const displayDescription = plainText.replace(/\n/g, '<br>');

    const itemHtml = `
        <div class="item-row border rounded p-2 mb-2" data-item-id="${itemCounter}">
            <!-- Display Mode -->
            <div class="item-display-mode">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="item-description-display mb-1">${displayDescription}</div>
                        <div class="text-muted">จำนวนเงิน: <span class="item-amount-display fw-bold">${amount.toLocaleString()}</span> บาท</div>
                        <input type="hidden" class="item-description-hidden" value="${description}">
                        <input type="hidden" class="item-amount-hidden" value="${amount}">
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-success" onclick="window.open('/accounts/receipt/${savedReceiptId}/pdf/', '_blank')" title="ดู PDF">
                            <i class="fas fa-file-pdf"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="editItem(${itemCounter})" title="แก้ไข">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(${itemCounter})" title="ลบ">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Edit Mode (hidden by default) -->
            <div class="item-edit-mode" style="display: none;">
                <div class="mb-3">
                    <label class="form-label fw-bold small">รายการ</label>
                    <textarea class="form-control form-control-sm item-description-edit" rows="3">${description}</textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold small">จำนวนเงิน (บาท)</label>
                    <input type="number" class="form-control form-control-sm item-amount-edit" step="0.01" value="${amount}">
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-success" onclick="saveItem(${itemCounter})">
                        <i class="fas fa-save me-1"></i> บันทึก
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="cancelEdit(${itemCounter})">
                        <i class="fas fa-times me-1"></i> ยกเลิก
                    </button>
                </div>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', itemHtml);
    calculateTotal();
}

// Remove item
function removeItem(itemId) {
    const item = document.querySelector(`[data-item-id="${itemId}"]`);
    if (item) {
        item.remove();
        calculateTotal();

        // Show empty message if no items left
        const container = document.getElementById('items-container');
        if (container.children.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-list-alt fa-2x mb-2"></i>
                    <p>กรุณาเพิ่มรายการรับเงิน</p>
                </div>
            `;
        }
    }
}

// Check if item is a food item
function isFoodItem(description) {
    const foodKeywords = ['ค่าอาหารเช้า', 'ค่าอาหารกลางวัน', 'ค่าอาหารเย็น', 'ค่าอาหารว่าง'];
    return foodKeywords.some(keyword => description.includes(keyword));
}

// Parse food item description back to fields
function parseFoodItem(description) {
    // Extract: "ค่าอาหารเช้า 1 มื้อ × 65 บาท × 5 คน (10 ตุลาคม 2568)"
    // Pattern: <name> <meals> มื้อ × <price> บาท × <people> คน (<date>)

    const result = {
        name: '',
        meals: 0,
        price: 0,
        people: 0,
        date: '',
        thaiDate: ''
    };

    // Extract food name
    if (description.includes('ค่าอาหารเช้า')) result.name = 'ค่าอาหารเช้า';
    else if (description.includes('ค่าอาหารกลางวัน')) result.name = 'ค่าอาหารกลางวัน';
    else if (description.includes('ค่าอาหารเย็น')) result.name = 'ค่าอาหารเย็น';
    else if (description.includes('ค่าอาหารว่าง')) result.name = 'ค่าอาหารว่าง';

    // Extract numbers: meals, price, people
    const numberPattern = /(\d+(?:\.\d+)?)\s*มื้อ\s*×\s*(\d+(?:\.\d+)?)\s*บาท\s*×\s*(\d+(?:\.\d+)?)\s*คน/;
    const match = description.match(numberPattern);

    if (match) {
        result.meals = parseFloat(match[1]);
        result.price = parseFloat(match[2]);
        result.people = parseFloat(match[3]);
    }

    // Extract Thai date and convert to ISO format
    const datePattern = /\((\d+)\s+(\S+)\s+(\d+)\)/;
    const dateMatch = description.match(datePattern);

    if (dateMatch) {
        const day = parseInt(dateMatch[1]);
        const monthName = dateMatch[2];
        const buddhistYear = parseInt(dateMatch[3]);

        result.thaiDate = `${day} ${monthName} ${buddhistYear}`;

        // Convert Thai month to number
        const thaiMonths = {
            'มกราคม': 0, 'กุมภาพันธ์': 1, 'มีนาคม': 2, 'เมษายน': 3,
            'พฤษภาคม': 4, 'มิถุนายน': 5, 'กรกฎาคม': 6, 'สิงหาคม': 7,
            'กันยายน': 8, 'ตุลาคม': 9, 'พฤศจิกายน': 10, 'ธันวาคม': 11
        };

        const monthIndex = thaiMonths[monthName];
        if (monthIndex !== undefined) {
            const gregorianYear = buddhistYear - 543;
            const date = new Date(gregorianYear, monthIndex, day);
            result.date = date.toISOString().split('T')[0]; // YYYY-MM-DD
        }
    }

    return result;
}

// Convert Thai date string to ISO format for date input
function convertThaiDateToISO(thaiDateStr) {
    // "10 ตุลาคม 2568" -> "2025-10-10"
    const datePattern = /(\d+)\s+(\S+)\s+(\d+)/;
    const match = thaiDateStr.match(datePattern);

    if (!match) return '';

    const day = parseInt(match[1]);
    const monthName = match[2];
    const buddhistYear = parseInt(match[3]);

    const thaiMonths = {
        'มกราคม': 0, 'กุมภาพันธ์': 1, 'มีนาคม': 2, 'เมษายน': 3,
        'พฤษภาคม': 4, 'มิถุนายน': 5, 'กรกฎาคม': 6, 'สิงหาคม': 7,
        'กันยายน': 8, 'ตุลาคม': 9, 'พฤศจิกายน': 10, 'ธันวาคม': 11
    };

    const monthIndex = thaiMonths[monthName];
    if (monthIndex === undefined) return '';

    const gregorianYear = buddhistYear - 543;
    const date = new Date(gregorianYear, monthIndex, day);
    return date.toISOString().split('T')[0];
}

// Render regular item edit form (textarea)
function renderRegularItemEditForm(item, description, amount) {
    // Hide display mode, show edit mode
    item.querySelector('.item-display-mode').style.display = 'none';
    const editMode = item.querySelector('.item-edit-mode');
    editMode.style.display = 'block';

    // Set textarea value
    const textarea = editMode.querySelector('.item-description-edit');
    textarea.value = description.trim();
    editMode.querySelector('.item-amount-edit').value = amount;
}

// Render food item edit form (special form with fields)
function renderFoodItemEditForm(item, foodData, originalAmount, itemId) {
    // Hide display mode
    item.querySelector('.item-display-mode').style.display = 'none';

    // Create custom edit form for food item
    const editMode = item.querySelector('.item-edit-mode');

    const html = `
        <div class="food-edit-form p-3 bg-light rounded">
            <h6 class="fw-bold mb-3">${foodData.name}</h6>
            <div class="row g-2">
                <div class="col-md-3">
                    <label class="form-label small">จำนวนมื้อ</label>
                    <input type="number" class="form-control form-control-sm food-edit-meals"
                           value="${foodData.meals}" min="0" step="1"
                           onchange="calculateFoodEditTotal(${itemId})">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">มื้อละ (บาท)</label>
                    <input type="number" class="form-control form-control-sm food-edit-price"
                           value="${foodData.price}" min="0" step="0.01"
                           onchange="calculateFoodEditTotal(${itemId})">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">จำนวนคน</label>
                    <input type="number" class="form-control form-control-sm food-edit-people"
                           value="${foodData.people}" min="0" step="1"
                           onchange="calculateFoodEditTotal(${itemId})">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">วันที่</label>
                    <input type="date" class="form-control form-control-sm food-edit-date"
                           value="${foodData.date}">
                </div>
                <div class="col-12">
                    <div class="alert alert-info mb-0 mt-2">
                        <strong>รวม: </strong>
                        <span id="food-edit-total-${itemId}" class="fs-6 fw-bold">${originalAmount.toLocaleString()} บาท</span>
                    </div>
                </div>
            </div>
            <div class="d-flex gap-2 mt-3">
                <button type="button" class="btn btn-sm btn-success" onclick="saveFoodItem(${itemId})">
                    <i class="fas fa-save me-1"></i> บันทึก
                </button>
                <button type="button" class="btn btn-sm btn-secondary" onclick="cancelEdit(${itemId})">
                    <i class="fas fa-times me-1"></i> ยกเลิก
                </button>
            </div>
        </div>
    `;

    editMode.innerHTML = html;
    editMode.style.display = 'block';
}

// Calculate total for food item being edited
function calculateFoodEditTotal(itemId) {
    const item = document.querySelector(`[data-item-id="${itemId}"]`);
    if (!item) return 0;

    const editMode = item.querySelector('.item-edit-mode');
    const meals = parseFloat(editMode.querySelector('.food-edit-meals')?.value) || 0;
    const price = parseFloat(editMode.querySelector('.food-edit-price')?.value) || 0;
    const people = parseFloat(editMode.querySelector('.food-edit-people')?.value) || 0;

    const total = meals * price * people;

    const totalElement = document.getElementById(`food-edit-total-${itemId}`);
    if (totalElement) {
        totalElement.textContent = total.toLocaleString('th-TH', {minimumFractionDigits: 2}) + ' บาท';
    }

    return total;
}

// Save food item after editing
function saveFoodItem(itemId) {
    const item = document.querySelector(`[data-item-id="${itemId}"]`);
    if (!item) return;

    const editMode = item.querySelector('.item-edit-mode');
    const meals = parseFloat(editMode.querySelector('.food-edit-meals')?.value) || 0;
    const price = parseFloat(editMode.querySelector('.food-edit-price')?.value) || 0;
    const people = parseFloat(editMode.querySelector('.food-edit-people')?.value) || 0;
    const date = editMode.querySelector('.food-edit-date')?.value || '';

    // Validate
    if (meals <= 0 || price <= 0 || people <= 0) {
        showToast('กรุณากรอกข้อมูลให้ครบถ้วน', 'warning');
        return;
    }

    // Calculate total
    const total = meals * price * people;

    // Get food name from the current description
    const originalDesc = item.querySelector('.item-description-hidden').value;
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = originalDesc;
    const plainText = tempDiv.textContent || tempDiv.innerText || '';
    const foodData = parseFoodItem(plainText);

    // Convert date to Thai format
    const thaiDate = date ? convertDateToThai(date) : '';
    const newDescription = `${foodData.name} ${meals} มื้อ × ${price} บาท × ${people} คน${thaiDate ? ' (' + thaiDate + ')' : ''}`;

    // Update hidden inputs
    item.querySelector('.item-description-hidden').value = newDescription;
    item.querySelector('.item-amount-hidden').value = total;

    // Update display
    item.querySelector('.item-description-display').textContent = newDescription;
    item.querySelector('.item-amount-display').textContent = total.toLocaleString();

    // Reset edit mode HTML to original structure
    editMode.innerHTML = `
        <div class="mb-3">
            <label class="form-label fw-bold small">รายการ</label>
            <textarea class="form-control form-control-sm item-description-edit" rows="3"></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold small">จำนวนเงิน (บาท)</label>
            <input type="number" class="form-control form-control-sm item-amount-edit" step="0.01">
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-success" onclick="saveItem(${itemId})">
                <i class="fas fa-save me-1"></i> บันทึก
            </button>
            <button type="button" class="btn btn-sm btn-secondary" onclick="cancelEdit(${itemId})">
                <i class="fas fa-times me-1"></i> ยกเลิก
            </button>
        </div>
    `;

    // Show display mode, hide edit mode
    item.querySelector('.item-display-mode').style.display = 'block';
    editMode.style.display = 'none';

    // Recalculate total
    calculateTotal();
}

// Convert date to Thai format (reuse from create page)
function convertDateToThai(dateString) {
    if (!dateString) return '';

    const thaiMonths = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                        'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];

    const date = new Date(dateString);
    const day = date.getDate();
    const month = thaiMonths[date.getMonth()];
    const year = date.getFullYear() + 543;

    return `${day} ${month} ${year}`;
}

// Edit item - Switch to edit mode
function editItem(itemId) {
    const item = document.querySelector(`[data-item-id="${itemId}"]`);
    if (!item) return;

    // Get original content from hidden input
    const originalDesc = item.querySelector('.item-description-hidden').value;
    const originalAmount = parseFloat(item.querySelector('.item-amount-hidden').value) || 0;

    // Strip HTML tags from the original description
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = originalDesc;
    const plainText = tempDiv.textContent || tempDiv.innerText || '';

    // Check if it's a food item
    if (isFoodItem(plainText)) {
        // Parse food item data
        const foodData = parseFoodItem(plainText);

        // Create food item edit form
        renderFoodItemEditForm(item, foodData, originalAmount, itemId);
    } else {
        // Regular item - use textarea
        renderRegularItemEditForm(item, plainText, originalAmount);
    }
}

// Cancel edit - Switch back to display mode
function cancelEdit(itemId) {
    const item = document.querySelector(`[data-item-id="${itemId}"]`);
    if (!item) return;

    const editMode = item.querySelector('.item-edit-mode');

    // Reset edit mode HTML to original structure
    editMode.innerHTML = `
        <div class="mb-3">
            <label class="form-label fw-bold small">รายการ</label>
            <textarea class="form-control form-control-sm item-description-edit" rows="3"></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label fw-bold small">จำนวนเงิน (บาท)</label>
            <input type="number" class="form-control form-control-sm item-amount-edit" step="0.01">
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-success" onclick="saveItem(${itemId})">
                <i class="fas fa-save me-1"></i> บันทึก
            </button>
            <button type="button" class="btn btn-sm btn-secondary" onclick="cancelEdit(${itemId})">
                <i class="fas fa-times me-1"></i> ยกเลิก
            </button>
        </div>
    `;

    // Show display mode, hide edit mode
    item.querySelector('.item-display-mode').style.display = 'block';
    editMode.style.display = 'none';
}

// Save item - Update and switch back to display mode
function saveItem(itemId) {
    const item = document.querySelector(`[data-item-id="${itemId}"]`);
    if (item) {
        // Get new values from textarea
        const textarea = item.querySelector('.item-description-edit');
        const newDescriptionText = textarea.value.trim();
        const newAmount = parseFloat(item.querySelector('.item-amount-edit').value) || 0;

        // Validate
        if (!newDescriptionText) {
            showToast('กรุณากรอกรายการ', 'warning');
            return;
        }

        if (newAmount <= 0) {
            showToast('กรุณากรอกจำนวนเงินที่ถูกต้อง', 'warning');
            return;
        }

        // Update hidden inputs (store plain text)
        item.querySelector('.item-description-hidden').value = newDescriptionText;
        item.querySelector('.item-amount-hidden').value = newAmount;

        // Update display (convert line breaks to <br> for display)
        const displayDescription = newDescriptionText.replace(/\n/g, '<br>');

        item.querySelector('.item-description-display').innerHTML = displayDescription;
        item.querySelector('.item-amount-display').textContent = newAmount.toLocaleString();

        // Show display mode, hide edit mode
        item.querySelector('.item-display-mode').style.display = 'block';
        item.querySelector('.item-edit-mode').style.display = 'none';

        // Recalculate total
        calculateTotal();
    }
}

// Calculate total amount
function calculateTotal() {
    let total = 0;
    let itemCount = 0;

    // Use the hidden input fields to calculate total
    document.querySelectorAll('.item-amount-hidden').forEach(input => {
        const value = parseFloat(input.value) || 0;
        total += value;
        if (value > 0) itemCount++;
    });

    // Format number with commas for Thai display
    const formattedTotal = formatNumber(total);

    const totalField = document.getElementById('total_amount');  // hidden field
    const totalDisplayField = document.getElementById('total_amount_display');  // display field
    const totalTextField = document.getElementById('total_amount_text');

    // อัปเดต hidden field ด้วยค่าตัวเลขล้วนๆ
    if (totalField) {
        totalField.value = total;
    }

    // อัปเดต display field ด้วยค่าที่มีจุลภาค
    if (totalDisplayField) {
        totalDisplayField.value = formattedTotal;
    }

    // อัปเดตตัวอ่านภาษาไทย
    if (totalTextField) {
        totalTextField.value = convertToThaiText(total);
        console.log('Updated Thai text:', convertToThaiText(total), 'for amount:', total);
    }
}

// Format number with commas
function formatNumber(num) {
    if (num === null || num === undefined || num === '') return '0.00';
    
    // แปลงเป็นตัวเลขก่อน
    const number = Number(num);
    if (isNaN(number)) return '0.00';
    
    // แบบง่ายๆ ไม่ใช้ regex
    const str = number.toFixed(2);
    const parts = str.split('.');
    const integerPart = parts[0];
    const decimalPart = parts[1];
    
    // เพิ่มจุลภาคทีละ 3 หลัก
    let formatted = '';
    for (let i = integerPart.length - 1, count = 0; i >= 0; i--, count++) {
        if (count > 0 && count % 3 === 0) {
            formatted = ',' + formatted;
        }
        formatted = integerPart[i] + formatted;
    }
    
    return formatted + '.' + decimalPart;
}

// Convert number to Thai text
function convertToThaiText(amount) {
    // ตรวจสอบ input ก่อน
    if (!amount || isNaN(amount) || amount <= 0) return 'ศูนย์บาทถ้วน';
    
    const ones = ['', 'หนึ่ง', 'สอง', 'สาม', 'สี่', 'ห้า', 'หก', 'เจ็ด', 'แปด', 'เก้า'];
    const units = ['', 'สิบ', 'ร้อย', 'พัน', 'หมื่น', 'แสน', 'ล้าน', 'สิบล้าน', 'ร้อยล้าน', 'พันล้าน'];
    
    function convertIntegerPart(num) {
        if (!num || num === 0) return '';
        
        let result = '';
        let unitIndex = 0;
        
        while (num > 0) {
            let digit = num % 10;
            
            if (digit > 0) {
                let digitText = '';
                
                if (unitIndex === 1) { // หลักสิบ
                    if (digit === 1) {
                        digitText = 'สิบ';
                    } else if (digit === 2) {
                        digitText = 'ยี่สิบ';
                    } else {
                        digitText = ones[digit] + 'สิบ';
                    }
                } else if (unitIndex === 0) { // หลักหน่วย
                    // กรณีพิเศษ: ถ้าเป็น "1" ในหลักหน่วยและมีตัวเลขหลักอื่นด้วย ให้ใช้ "เอ็ด"
                    if (digit === 1 && num >= 10) {
                        digitText = 'เอ็ด';
                    } else {
                        digitText = ones[digit];
                    }
                } else { // หลักอื่นๆ (ร้อย, พัน, หมื่น, แสน, ล้าน...)
                    // กรณีพิเศษสำหรับ "หนึ่ง" ในหลักที่มากกว่าหลักหน่วย
                    if (digit === 1 && unitIndex > 1) {
                        // ถ้าเป็น "หนึ่ง" ในหลักร้อย, พัน, หมื่น, แสน ให้ใส่ "หนึ่ง"
                        // แต่ถ้าเป็นหลักล้านขึ้นไป และเป็นเลข 1 ในหลักสูงสุด ให้ไม่ใส่ "หนึ่ง"
                        if (unitIndex >= 6 && num < 10) { // ล้าน, สิบล้าน, ร้อยล้าน และเป็นหลักเดียว
                            digitText = units[unitIndex];
                        } else {
                            digitText = ones[digit] + units[unitIndex];
                        }
                    } else {
                        digitText = ones[digit];
                        if (unitIndex > 0 && units[unitIndex]) {
                            digitText += units[unitIndex];
                        }
                    }
                }
                
                result = digitText + result;
            }
            
            num = Math.floor(num / 10);
            unitIndex++;
        }
        
        return result;
    }
    
    // แปลงเป็น number และตรวจสอบ
    const numAmount = Number(amount);
    if (isNaN(numAmount)) return 'จำนวนเงินไม่ถูกต้อง';
    
    const integerPart = Math.floor(numAmount);
    const decimalPart = Math.round((numAmount - integerPart) * 100);
    
    let result = '';
    
    // ส่วนบาท
    const bahtText = convertIntegerPart(integerPart);
    result = (bahtText || 'ศูนย์') + 'บาท';
    
    // ส่วนสตางค์
    if (decimalPart > 0) {
        const satangText = convertIntegerPart(decimalPart);
        result += satangText + 'สตางค์';
    } else {
        result += 'ถ้วน';
    }
    
    return result;
}

// Form actions
function updateDraft() {
    updateReceipt('draft', false);
}

// Show confirmation modal before completing
function showCompleteConfirmation() {
    // Validate form first
    const form = document.getElementById('receiptForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    // Check items
    const items = [];
    document.querySelectorAll('.item-row').forEach(row => {
        const description = row.querySelector('.item-description-hidden').value.trim();
        const amount = parseFloat(row.querySelector('.item-amount-hidden').value) || 0;

        if (description && amount > 0) {
            items.push({
                description: description,
                amount: amount
            });
        }
    });

    if (items.length === 0) {
        showToast('กรุณาเพิ่มรายการรับเงิน', 'warning');
        return;
    }

    // Populate modal with data
    document.getElementById('confirm-recipient-name').textContent = document.getElementById('recipient_name').value;
    document.getElementById('confirm-id-card').textContent = document.getElementById('recipient_id_card').value;

    const totalAmount = parseFloat(document.getElementById('total_amount').value || 0);
    document.getElementById('confirm-total-amount').textContent = totalAmount.toLocaleString('th-TH', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }) + ' บาท';

    // Show items list
    let itemsHTML = '<ul class="mb-0">';
    items.forEach((item, index) => {
        itemsHTML += `<li>${item.description}: ${item.amount.toLocaleString('th-TH', {minimumFractionDigits: 2})} บาท</li>`;
    });
    itemsHTML += '</ul>';
    document.getElementById('confirm-items-list').innerHTML = itemsHTML;

    // Reset checkbox
    document.getElementById('confirmCheckbox').checked = false;
    document.getElementById('confirmCompleteBtn').disabled = true;

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('completeConfirmationModal'));
    modal.show();
}

// Toggle confirm button based on checkbox
function toggleConfirmButton() {
    const checkbox = document.getElementById('confirmCheckbox');
    const confirmBtn = document.getElementById('confirmCompleteBtn');
    confirmBtn.disabled = !checkbox.checked;
}

// Open preview PDF in new window
function openPreviewPDF() {
    window.open(`/accounts/receipt/${savedReceiptId}/pdf/`, '_blank');
}

// Confirm and complete receipt
function confirmComplete() {
    // Hide modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('completeConfirmationModal'));
    modal.hide();

    // Save and complete
    updateReceipt('completed', true);
}

// Legacy function (kept for backward compatibility)
function updateAndComplete() {
    showCompleteConfirmation();
}

function updateReceipt(status, redirectToDetail = false) {
    // Validate form
    const form = document.getElementById('receiptForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    // Check items
    const items = [];
    document.querySelectorAll('.item-row').forEach(row => {
        const description = row.querySelector('.item-description-hidden').value.trim();
        const amount = parseFloat(row.querySelector('.item-amount-hidden').value) || 0;

        if (description && amount > 0) {
            items.push({
                description: description,
                amount: amount
            });
        }
    });

    if (items.length === 0) {
        showToast('กรุณาเพิ่มรายการรับเงิน', 'warning');
        return;
    }

    // Prepare data
    const data = {
        recipient_name: document.getElementById('recipient_name').value,
        recipient_address: document.getElementById('recipient_address').value,
        recipient_postal_code: document.getElementById('recipient_postal_code').value,
        recipient_id_card: document.getElementById('recipient_id_card').value,
        receipt_date: document.getElementById('receipt_date').value,
        is_loan: document.querySelector('input[name="is_loan"]:checked').value === 'true',
        total_amount: parseFloat(document.getElementById('total_amount').value || 0),
        status: status,
        items: items
    };

    // Show loading
    let submitBtn;
    if (redirectToDetail) {
        submitBtn = document.querySelector('button[onclick="updateAndComplete()"]');
    } else {
        submitBtn = document.querySelector('button[onclick="updateDraft()"]');
    }

    if (submitBtn) {
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังอัปเดต...';
        submitBtn.disabled = true;

        // เก็บ reference เพื่อใช้ใน finally
        window.tempSubmitBtn = submitBtn;
        window.tempOriginalText = originalText;
    }

    // Send AJAX request
    fetch(`/accounts/receipt/${savedReceiptId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const receiptNumberText = data.receipt_number ? `เลขที่: ${data.receipt_number}` : '(ร่าง - ยังไม่มีเลข)';
            if (redirectToDetail) {
                showToast('success', 'บันทึกสำเร็จ!', `${receiptNumberText}<br>กำลังนำไปยังหน้ารายละเอียด...`);
                setTimeout(() => {
                    window.location.href = `/receipt/${savedReceiptId}/`;
                }, 2000);
            } else {
                showToast('success', 'บันทึกร่างสำเร็จ!', receiptNumberText);
                // Re-enable button after saving draft
                if (window.tempSubmitBtn) {
                    window.tempSubmitBtn.innerHTML = window.tempOriginalText;
                    window.tempSubmitBtn.disabled = false;
                    window.tempSubmitBtn = null;
                    window.tempOriginalText = null;
                }
            }
        } else {
            showToast('error', 'เกิดข้อผิดพลาด', data.message || 'ไม่สามารถบันทึกได้');
            // Re-enable button on error
            if (window.tempSubmitBtn) {
                window.tempSubmitBtn.innerHTML = window.tempOriginalText;
                window.tempSubmitBtn.disabled = false;
                window.tempSubmitBtn = null;
                window.tempOriginalText = null;
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'เกิดข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์');
        // Re-enable button on error
        if (window.tempSubmitBtn) {
            window.tempSubmitBtn.innerHTML = window.tempOriginalText;
            window.tempSubmitBtn.disabled = false;
            window.tempSubmitBtn = null;
            window.tempOriginalText = null;
        }
    });
}

// Show toast notification
function showToast(type, title, message) {
    const toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) return;

    const toastId = 'toast-' + Date.now();
    const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';

    const toastHTML = `
        <div id="${toastId}" class="toast align-items-center ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true" style="margin-left: auto;">
            <div class="d-flex">
                <div class="toast-body">
                    <strong>${title}</strong><br>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;

    toastContainer.insertAdjacentHTML('beforeend', toastHTML);

    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: 4000
    });

    toast.show();

    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}

// Initialize receipt date field with validation
function initializeReceiptDateField() {
    const receiptDateInput = document.getElementById('receipt_date');
    if (!receiptDateInput) return;

    const today = new Date();

    // Calculate fiscal year start (1 October)
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth(); // 0-indexed (0 = January, 9 = October)
    let fiscalYearStart;

    if (currentMonth >= 9) { // October or later
        fiscalYearStart = new Date(currentYear, 9, 1); // October 1 of current year
    } else { // Before October
        fiscalYearStart = new Date(currentYear - 1, 9, 1); // October 1 of previous year
    }

    const minDate = fiscalYearStart.toISOString().split('T')[0];
    const maxDate = today.toISOString().split('T')[0];

    receiptDateInput.setAttribute('min', minDate);
    receiptDateInput.setAttribute('max', maxDate);

    // Add change event listener
    receiptDateInput.addEventListener('change', function() {
        validateReceiptDate(this, minDate, maxDate, fiscalYearStart, today);
    });

    // Validate current value if exists
    if (receiptDateInput.value) {
        validateReceiptDate(receiptDateInput, minDate, maxDate, fiscalYearStart, today);
    }
}

// Format date to Thai format
function formatDateThai(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    const thaiYear = date.getFullYear() + 543;
    const thaiMonths = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                        'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
    return `${date.getDate()} ${thaiMonths[date.getMonth()]} ${thaiYear}`;
}

// Validate receipt date
function validateReceiptDate(input, minDate, maxDate, fiscalYearStart, today) {
    const selectedDate = new Date(input.value);
    const helpText = document.getElementById('receipt_date_help');

    if (!input.value) {
        input.setCustomValidity('กรุณาเลือกวันที่');
        if (helpText) {
            helpText.textContent = 'กรุณาเลือกวันที่ออกใบสำคัญ';
            helpText.className = 'form-text text-danger';
        }
        return false;
    }

    // Check if future date
    if (selectedDate > today) {
        input.setCustomValidity('ไม่สามารถกำหนดวันที่ล่วงหน้าได้');
        if (helpText) {
            helpText.textContent = '❌ ไม่สามารถกำหนดวันที่ล่วงหน้าได้';
            helpText.className = 'form-text text-danger';
        }
        input.classList.add('is-invalid');
        return false;
    }

    // Check if before fiscal year start
    if (selectedDate < fiscalYearStart) {
        input.setCustomValidity('วันที่ย้อนหลังเกินกำหนด (ต้นปีงบประมาณคือ ' + formatDateThai(minDate) + ')');
        if (helpText) {
            helpText.textContent = '❌ วันที่ย้อนหลังเกินกำหนด (ต้นปีงบประมาณคือ ' + formatDateThai(minDate) + ')';
            helpText.className = 'form-text text-danger';
        }
        input.classList.add('is-invalid');
        return false;
    }

    // Valid date
    input.setCustomValidity('');
    if (helpText) {
        helpText.textContent = '✓ วันที่ถูกต้อง (' + formatDateThai(input.value) + ')';
        helpText.className = 'form-text text-success';
    }
    input.classList.remove('is-invalid');
    input.classList.add('is-valid');
    return true;
}
</script>

<style>
/* Tab styling */
.nav-tabs-custom {
    border-bottom: 2px solid #e5e7eb;
}

.nav-tabs-custom .nav-link {
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    color: #6b7280;
    font-weight: 500;
    padding: 12px 20px;
    margin-bottom: -2px;
    transition: all 0.3s ease;
}

.nav-tabs-custom .nav-link:hover {
    color: #002F6C;
    border-bottom-color: #CFAE43;
    background-color: rgba(207, 174, 67, 0.1);
}

.nav-tabs-custom .nav-link.active {
    color: #002F6C;
    border-bottom-color: #CFAE43;
    background-color: rgba(207, 174, 67, 0.1);
    font-weight: 600;
}

/* Item styling */
.item-row {
    background-color: #fff;
    transition: all 0.2s ease;
    border: 1px solid #e5e7eb !important;
}

.item-row:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border-color: #CFAE43 !important;
}

/* Form styling */
.tab-content {
    padding-top: 20px;
}

.form-control:focus {
    border-color: #CFAE43;
    box-shadow: 0 0 0 0.2rem rgba(207, 174, 67, 0.25);
}

.btn-success {
    background-color: #CFAE43;
    border-color: #CFAE43;
}

.btn-success:hover {
    background-color: #b8951a;
    border-color: #b8951a;
}

.toast-body {
    padding: 1rem;
    color: white !important;
}

.toast-body * {
    color: white !important;
}
</style>

<!-- jQuery (included for Bootstrap compatibility) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}