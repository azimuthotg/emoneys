{% extends 'base_sidebar.html' %}
{% load humanize %}
{% load static %}

{% block title %}{{ title }} - ระบบออกใบสำคัญรับเงิน{% endblock %}
{% block page_title %}{{ title }}{% endblock %}

{% block extra_css %}
<!-- Summernote CSS -->
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<!-- Toast Container -->
<div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 9999; right: 0;"></div>

<!-- Header Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);">
            <div class="card-body text-white p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-2 fw-bold">
                            <i class="fas fa-edit me-2"></i>
                            แก้ไขใบสำคัญรับเงิน (ร่าง)
                        </h5>
                        <p class="mb-0 opacity-90">
                            <i class="fas fa-building me-2"></i>
                            {{ department.name }} ({{ department.code }})
                        </p>
                        <p class="mb-0 opacity-75">
                            <i class="fas fa-file-alt me-2"></i>
                            เลขที่: {% if receipt.receipt_number %}{{ receipt.receipt_number }}{% else %}(ยังไม่มีเลข){% endif %}
                        </p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <i class="fas fa-file-edit" style="font-size: 3rem; opacity: 0.3;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Receipt Form -->
<div class="row">
    <!-- Form Section (Full Width) -->
    <div class="col-12">
        <form id="receiptForm">
            {% csrf_token %}
            
            <!-- Recipient Information -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3">
                    <h6 class="mb-0 fw-bold" style="color: #CFAE43;">
                        <i class="fas fa-user me-2"></i>
                        ข้อมูลผู้รับเงิน
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="recipient_name" class="form-label fw-bold">ชื่อผู้รับเงิน <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="recipient_name" name="recipient_name"
                                   value="{{ receipt.recipient_name }}" required>
                            <div class="form-text">ข้าพเจ้า ...</div>
                        </div>
                        <div class="col-12">
                            <label for="recipient_address" class="form-label fw-bold">ที่อยู่ <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="recipient_address" name="recipient_address" rows="3" required>{{ receipt.recipient_address }}</textarea>
                            <div class="form-text">บ้านเลขที่ หมู่ ซอย ถนน ตำบล อำเภอ จังหวัด</div>
                        </div>
                        <div class="col-md-6">
                            <label for="recipient_postal_code" class="form-label fw-bold">รหัสไปรษณีย์</label>
                            <input type="text" class="form-control" id="recipient_postal_code" name="recipient_postal_code"
                                   pattern="[0-9]{5}" maxlength="5" value="{{ receipt.recipient_postal_code }}">
                        </div>
                        <div class="col-md-6">
                            <label for="recipient_id_card" class="form-label fw-bold">เลขบัตรประชาชน <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="recipient_id_card" name="recipient_id_card"
                                   pattern="[0-9]{13}" maxlength="13" value="{{ receipt.recipient_id_card }}" required>
                            <div class="form-text">13 หลัก ไม่ต้องใส่เครื่องหมาย</div>
                        </div>
                        <div class="col-12">
                            <label for="is_loan" class="form-label fw-bold">ประเภทการจ่าย</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="is_loan" id="is_loan_false" value="false"
                                       {% if not receipt.is_loan %}checked{% endif %}>
                                <label class="form-check-label" for="is_loan_false">
                                    <i class="fas fa-hand-holding-usd me-1"></i>
                                    จ่ายปกติ
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="is_loan" id="is_loan_true" value="true"
                                       {% if receipt.is_loan %}checked{% endif %}>
                                <label class="form-check-label" for="is_loan_true">
                                    <i class="fas fa-handshake me-1"></i>
                                    ยืมเงิน (ใช้ชื่อ {{ user_full_name }} เป็นผู้จ่าย)
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Receipt Items -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3">
                    <h6 class="mb-3 fw-bold" style="color: #CFAE43;">
                        <i class="fas fa-list me-2"></i>
                        รายการรับเงิน
                    </h6>
                    
                    <!-- Input Type Tabs -->
                    <ul class="nav nav-tabs nav-tabs-custom" id="inputTypeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="multi-line-tab" data-bs-toggle="tab"
                                    data-bs-target="#multi-line" type="button" role="tab">
                                <i class="fas fa-align-left me-2"></i>Multi Line
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="template-tab" data-bs-toggle="tab"
                                    data-bs-target="#template" type="button" role="tab">
                                <i class="fas fa-clipboard-list me-2"></i>Template
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <!-- Tab Content -->
                    <div class="tab-content" id="inputTypeTabContent">
                        <!-- Multi Line Tab -->
                        <div class="tab-pane fade show active" id="multi-line" role="tabpanel">
                            <div class="row g-3 mb-3">
                                <div class="col-md-8">
                                    <label class="form-label fw-bold">รายการ (หลายบรรทัด)</label>
                                    <textarea class="form-control" id="multi-item-description" rows="5" 
                                              placeholder="กรอกรายการรับเงิน (สามารถขึ้นบรรทัดใหม่ได้)..."></textarea>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">จำนวนเงิน</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="multi-item-amount" 
                                               step="0.01" min="0" placeholder="0.00">
                                        <span class="input-group-text">บาท</span>
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label fw-bold">&nbsp;</label>
                                    <button type="button" class="btn btn-success w-100" onclick="addItemFromMultiLine()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Template Tab -->
                        <div class="tab-pane fade" id="template" role="tabpanel">
                            <div class="row g-3 mb-3">
                                <div class="col-md-8">
                                    <label class="form-label fw-bold">เลือก Template</label>
                                    <select class="form-select" id="template-select" onchange="fillTemplateData()">
                                        <option value="">-- เลือกรายการสำเร็จรูป --</option>
                                        {% for template in receipt_templates %}
                                        <option value="{{ template.id }}" 
                                                data-name="{{ template.name }}"
                                                data-fixed-amount="{{ template.fixed_amount|default:'0' }}"
                                                data-max-amount="{{ template.max_amount|default:'0' }}">
                                            {{ template.name }}
                                            {% if template.fixed_amount %}({{ template.fixed_amount|floatformat:0|intcomma }} บาท){% endif %}
                                            {% if template.max_amount %}(สูงสุด {{ template.max_amount|floatformat:0|intcomma }} บาท){% endif %}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">จำนวนเงิน</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="template-item-amount" 
                                               step="0.01" min="0" placeholder="0.00" onchange="validateTemplateAmount()">
                                        <span class="input-group-text">บาท</span>
                                    </div>
                                    <div id="template-amount-helper" class="form-text"></div>
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label fw-bold">&nbsp;</label>
                                    <button type="button" class="btn btn-success w-100" onclick="addItemFromTemplate()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Items List -->
                    <div class="mt-4">
                        <h6 class="fw-bold mb-3">รายการที่เพิ่มแล้ว</h6>
                    <div id="items-container">
                        <!-- Items will be loaded from existing receipt -->
                    </div>
                    
                    <!-- Total Amount Display -->
                    <div class="row mt-4 pt-3 border-top">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">จำนวนเงินรวม (ตัวเลข)</label>
                            <div class="input-group">
                                <input type="text" class="form-control form-control-lg" id="total_amount_display" readonly 
                                       style="font-size: 1.2rem; font-weight: bold; text-align: right;">
                                <span class="input-group-text">บาท</span>
                            </div>
                            <!-- Hidden field สำหรับเก็บค่าตัวเลขจริง -->
                            <input type="hidden" id="total_amount" name="total_amount">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">จำนวนเงิน (ตัวหนังสือ)</label>
                            <input type="text" class="form-control form-control-lg" id="total_amount_text" readonly 
                                   style="font-family: 'Sarabun', sans-serif;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row">
                <div class="col-12">
                    <div class="d-flex gap-2 justify-content-end align-items-center">
                        <a href="{% url 'receipt_detail' receipt.id %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>
                            ยกเลิก
                        </a>
                        <button type="button" class="btn btn-warning" onclick="updateDraft()">
                            <i class="fas fa-save me-2"></i>
                            บันทึกร่าง
                        </button>
                        <button type="button" class="btn btn-success btn-lg px-4" onclick="showCompleteConfirmation()">
                            <i class="fas fa-check-circle me-2"></i>
                            บันทึกใบสำคัญ
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Complete Confirmation Modal -->
<div class="modal fade" id="completeConfirmationModal" tabindex="-1" aria-labelledby="completeConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="completeConfirmationModalLabel">
                    <i class="fas fa-check-circle me-2"></i>
                    ยืนยันการบันทึกใบสำคัญรับเงิน
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Summary Section -->
                <div class="alert alert-info mb-4">
                    <h6 class="fw-bold mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        สรุปข้อมูลใบสำคัญรับเงิน
                    </h6>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <strong>ชื่อผู้รับเงิน:</strong>
                            <div id="confirm-recipient-name" class="ms-3"></div>
                        </div>
                        <div class="col-md-6">
                            <strong>เลขบัตรประชาชน:</strong>
                            <div id="confirm-id-card" class="ms-3 font-monospace"></div>
                        </div>
                        <div class="col-12">
                            <strong>จำนวนเงินรวม:</strong>
                            <div id="confirm-total-amount" class="ms-3 fs-5 text-success fw-bold"></div>
                        </div>
                        <div class="col-12">
                            <strong>รายการ:</strong>
                            <div id="confirm-items-list" class="ms-3"></div>
                        </div>
                    </div>
                </div>

                <!-- Warning Section -->
                <div class="alert alert-warning mb-4">
                    <h6 class="fw-bold mb-2">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        คำเตือนสำคัญ
                    </h6>
                    <ul class="mb-0">
                        <li>เมื่อบันทึกเป็น <strong>"เสร็จสิ้น"</strong> แล้ว <strong class="text-danger">ไม่สามารถแก้ไขได้โดยตรง</strong></li>
                        <li>หากต้องการแก้ไข จะต้อง <strong>ส่งคำขอแก้ไข</strong> และรอการอนุมัติจากผู้จัดการ</li>
                        <li>กรุณาตรวจสอบข้อมูลให้ถูกต้องก่อนยืนยัน</li>
                    </ul>
                </div>

                <!-- Preview PDF Link -->
                <div class="text-center mb-3">
                    <button type="button" class="btn btn-outline-primary" onclick="openPreviewPDF()">
                        <i class="fas fa-file-pdf me-2"></i>
                        ดูตัวอย่าง PDF ก่อนบันทึก (แนะนำ)
                    </button>
                </div>

                <!-- Confirmation Checkbox -->
                <div class="form-check p-3 bg-light rounded">
                    <input class="form-check-input" type="checkbox" id="confirmCheckbox" onchange="toggleConfirmButton()">
                    <label class="form-check-label fw-bold" for="confirmCheckbox">
                        ข้าพเจ้าได้ตรวจสอบข้อมูลถูกต้องครบถ้วนแล้ว และยอมรับว่าหากต้องการแก้ไขจะต้องขออนุมัติ
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    ยกเลิก
                </button>
                <button type="button" class="btn btn-success" id="confirmCompleteBtn" onclick="confirmComplete()" disabled>
                    <i class="fas fa-check-circle me-2"></i>
                    ยืนยันบันทึกใบสำคัญ
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let itemCounter = 0;
let savedReceiptId = {{ receipt.id }};

// Load existing items on page load
document.addEventListener('DOMContentLoaded', function() {
    loadExistingItems();
    calculateTotal();
});

// Load existing receipt items
function loadExistingItems() {
    const container = document.getElementById('items-container');
    container.innerHTML = ''; // Clear container
    
    // Load items from server data
    const existingItems = [
        {% for item in receipt_items %}
        {
            id: {{ item.id }},
            description: `{{ item.description|escapejs }}`,
            amount: {{ item.amount }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    if (existingItems.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-list-alt fa-2x mb-2"></i>
                <p>กรุณาเพิ่มรายการรับเงิน</p>
            </div>
        `;
        return;
    }
    
    existingItems.forEach((item, index) => {
        itemCounter++;

        // Convert HTML to display text with line breaks preserved
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = item.description;

        // Replace block elements with newlines before getting text
        tempDiv.querySelectorAll('p, div, br').forEach(el => {
            if (el.tagName === 'BR') {
                el.replaceWith('\n');
            } else {
                el.insertAdjacentText('afterend', '\n');
            }
        });

        const plainText = (tempDiv.textContent || tempDiv.innerText || '').trim();
        const displayDescription = plainText.replace(/\n/g, '<br>');

        // Escape HTML for use in textarea value attribute
        const escapedDescription = item.description.replace(/"/g, '&quot;');

        const itemHtml = `
            <div class="item-row border rounded p-3 mb-3" data-item-id="${itemCounter}">
                <!-- Display Mode -->
                <div class="item-display-mode">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="item-description-display mb-1">${displayDescription}</div>
                            <div class="text-muted">จำนวนเงิน: <span class="item-amount-display fw-bold">${item.amount.toLocaleString()}</span> บาท</div>
                            <input type="hidden" class="item-description-hidden" value="${escapedDescription}">
                            <input type="hidden" class="item-amount-hidden" value="${item.amount}">
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-success" onclick="window.open('/accounts/receipt/${savedReceiptId}/pdf/', '_blank')" title="ดู PDF">
                                <i class="fas fa-file-pdf"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="editItem(${itemCounter})" title="แก้ไข">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(${itemCounter})" title="ลบ">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Edit Mode (hidden by default) -->
                <div class="item-edit-mode" style="display: none;">
                    <div class="mb-3">
                        <label class="form-label fw-bold">รายการ</label>
                        <textarea class="form-control item-description-edit" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">จำนวนเงิน (บาท)</label>
                        <input type="number" class="form-control item-amount-edit" step="0.01" value="${item.amount}">
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-success" onclick="saveItem(${itemCounter})">
                            <i class="fas fa-save me-1"></i> บันทึก
                        </button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="cancelEdit(${itemCounter})">
                            <i class="fas fa-times me-1"></i> ยกเลิก
                        </button>
                    </div>
                </div>
            </div>
        `;

        container.insertAdjacentHTML('beforeend', itemHtml);
    });
}

// Add item from Multi Line tab
function addItemFromMultiLine() {
    // Get HTML content from Summernote
    const description = $('#multi-item-description').summernote('code').trim();
    const amount = parseFloat(document.getElementById('multi-item-amount').value) || 0;

    // Check if description is empty (Summernote returns <p><br></p> when empty)
    const isEmpty = !description || description === '<p><br></p>' || description === '';

    if (isEmpty) {
        alert('กรุณากรอกรายการ');
        return;
    }

    if (amount <= 0) {
        alert('กรุณากรอกจำนวนเงินที่ถูกต้อง');
        return;
    }

    addItemToList(description, amount);

    // Clear inputs
    $('#multi-item-description').summernote('reset');
    document.getElementById('multi-item-amount').value = '';
}

// Fill template data when template is selected
function fillTemplateData() {
    const select = document.getElementById('template-select');
    const amountInput = document.getElementById('template-item-amount');
    const helper = document.getElementById('template-amount-helper');
    
    if (!select.value) {
        amountInput.value = '';
        helper.textContent = '';
        return;
    }
    
    const option = select.selectedOptions[0];
    const fixedAmount = parseFloat(option.dataset.fixedAmount) || 0;
    const maxAmount = parseFloat(option.dataset.maxAmount) || 0;
    
    if (fixedAmount > 0) {
        amountInput.value = fixedAmount;
        amountInput.readOnly = true;
        helper.textContent = `จำนวนเงินคงที่ ${fixedAmount.toLocaleString()} บาท`;
        helper.className = 'form-text text-info';
    } else if (maxAmount > 0) {
        amountInput.value = '';
        amountInput.readOnly = false;
        helper.textContent = `ไม่เกิน ${maxAmount.toLocaleString()} บาท`;
        helper.className = 'form-text text-warning';
    } else {
        amountInput.value = '';
        amountInput.readOnly = false;
        helper.textContent = 'ระบุจำนวนเงินได้อย่างอิสระ';
        helper.className = 'form-text text-muted';
    }
}

// Validate template amount
function validateTemplateAmount() {
    const select = document.getElementById('template-select');
    const amountInput = document.getElementById('template-item-amount');
    const helper = document.getElementById('template-amount-helper');
    
    if (!select.value) return;
    
    const option = select.selectedOptions[0];
    const maxAmount = parseFloat(option.dataset.maxAmount) || 0;
    const inputAmount = parseFloat(amountInput.value) || 0;
    
    if (maxAmount > 0 && inputAmount > maxAmount) {
        helper.textContent = `เกินขีดจำกัด! ไม่เกิน ${maxAmount.toLocaleString()} บาท`;
        helper.className = 'form-text text-danger';
        amountInput.classList.add('is-invalid');
    } else if (maxAmount > 0) {
        helper.textContent = `ไม่เกิน ${maxAmount.toLocaleString()} บาท`;
        helper.className = 'form-text text-warning';
        amountInput.classList.remove('is-invalid');
    }
}

// Add item from Template tab
function addItemFromTemplate() {
    const select = document.getElementById('template-select');
    const amountInput = document.getElementById('template-item-amount');
    
    if (!select.value) {
        alert('กรุณาเลือก Template');
        return;
    }
    
    const option = select.selectedOptions[0];
    const description = option.dataset.name;
    const amount = parseFloat(amountInput.value) || 0;
    const maxAmount = parseFloat(option.dataset.maxAmount) || 0;
    
    if (amount <= 0) {
        alert('กรุณากรอกจำนวนเงินที่ถูกต้อง');
        return;
    }
    
    if (maxAmount > 0 && amount > maxAmount) {
        alert(`จำนวนเงินเกินขีดจำกัด ไม่เกิน ${maxAmount.toLocaleString()} บาท`);
        return;
    }
    
    addItemToList(description, amount);
    
    // Clear inputs
    select.value = '';
    amountInput.value = '';
    document.getElementById('template-amount-helper').textContent = '';
    amountInput.readOnly = false;
    amountInput.classList.remove('is-invalid');
}

// Common function to add item to list
function addItemToList(description, amount) {
    itemCounter++;
    const container = document.getElementById('items-container');

    // Remove empty message if it exists
    const emptyMessage = container.querySelector('.text-center');
    if (emptyMessage) {
        emptyMessage.remove();
    }

    // Convert HTML to display text with line breaks preserved
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = description;

    // Replace block elements with newlines before getting text
    tempDiv.querySelectorAll('p, div, br').forEach(el => {
        if (el.tagName === 'BR') {
            el.replaceWith('\n');
        } else {
            el.insertAdjacentText('afterend', '\n');
        }
    });

    const plainText = (tempDiv.textContent || tempDiv.innerText || '').trim();
    const displayDescription = plainText.replace(/\n/g, '<br>');

    const itemHtml = `
        <div class="item-row border rounded p-3 mb-3" data-item-id="${itemCounter}">
            <!-- Display Mode -->
            <div class="item-display-mode">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="item-description-display mb-1">${displayDescription}</div>
                        <div class="text-muted">จำนวนเงิน: <span class="item-amount-display fw-bold">${amount.toLocaleString()}</span> บาท</div>
                        <input type="hidden" class="item-description-hidden" value="${description}">
                        <input type="hidden" class="item-amount-hidden" value="${amount}">
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-success" onclick="window.open('/accounts/receipt/${savedReceiptId}/pdf/', '_blank')" title="ดู PDF">
                            <i class="fas fa-file-pdf"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="editItem(${itemCounter})" title="แก้ไข">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeItem(${itemCounter})" title="ลบ">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Edit Mode (hidden by default) -->
            <div class="item-edit-mode" style="display: none;">
                <div class="mb-3">
                    <label class="form-label fw-bold">รายการ</label>
                    <textarea class="form-control item-description-edit" rows="3">${description}</textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">จำนวนเงิน (บาท)</label>
                    <input type="number" class="form-control item-amount-edit" step="0.01" value="${amount}">
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-sm btn-success" onclick="saveItem(${itemCounter})">
                        <i class="fas fa-save me-1"></i> บันทึก
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="cancelEdit(${itemCounter})">
                        <i class="fas fa-times me-1"></i> ยกเลิก
                    </button>
                </div>
            </div>
        </div>
    `;

    container.insertAdjacentHTML('beforeend', itemHtml);
    calculateTotal();
}

// Remove item
function removeItem(itemId) {
    const item = document.querySelector(`[data-item-id="${itemId}"]`);
    if (item) {
        item.remove();
        calculateTotal();

        // Show empty message if no items left
        const container = document.getElementById('items-container');
        if (container.children.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-list-alt fa-2x mb-2"></i>
                    <p>กรุณาเพิ่มรายการรับเงิน</p>
                </div>
            `;
        }
    }
}

// Edit item - Switch to edit mode
function editItem(itemId) {
    const item = document.querySelector(`[data-item-id="${itemId}"]`);
    if (item) {
        // Get original HTML content from hidden input
        const originalDesc = item.querySelector('.item-description-hidden').value;

        // Hide display mode, show edit mode
        item.querySelector('.item-display-mode').style.display = 'none';
        item.querySelector('.item-edit-mode').style.display = 'block';

        // Initialize Summernote for this item's textarea
        const textarea = item.querySelector('.item-description-edit');
        $(textarea).summernote({
            height: 200,
            lang: 'th-TH',
            toolbar: [
                ['view', ['fullscreen', 'codeview']]
            ],
            placeholder: 'พิมพ์รายการรับเงิน (กด Enter เพื่อขึ้นบรรทัดใหม่)',
            disableDragAndDrop: true,
            fontNames: ['Sarabun', 'THSarabunNew', 'Arial', 'Tahoma'],
            fontNamesIgnoreCheck: ['Sarabun', 'THSarabunNew']
        });

        // Load HTML content into Summernote
        $(textarea).summernote('code', originalDesc);
    }
}

// Cancel edit - Switch back to display mode
function cancelEdit(itemId) {
    const item = document.querySelector(`[data-item-id="${itemId}"]`);
    if (item) {
        // Destroy Summernote
        const textarea = item.querySelector('.item-description-edit');
        if ($(textarea).data('summernote')) {
            $(textarea).summernote('destroy');
        }

        // Reset edit fields to original values
        const originalDesc = item.querySelector('.item-description-hidden').value;
        const originalAmount = item.querySelector('.item-amount-hidden').value;

        textarea.value = originalDesc;
        item.querySelector('.item-amount-edit').value = originalAmount;

        // Show display mode, hide edit mode
        item.querySelector('.item-display-mode').style.display = 'block';
        item.querySelector('.item-edit-mode').style.display = 'none';
    }
}

// Save item - Update and switch back to display mode
function saveItem(itemId) {
    const item = document.querySelector(`[data-item-id="${itemId}"]`);
    if (item) {
        // Get new values from Summernote
        const textarea = item.querySelector('.item-description-edit');
        const newDescriptionHTML = $(textarea).summernote('code').trim();
        const newAmount = parseFloat(item.querySelector('.item-amount-edit').value) || 0;

        // Check if empty (Summernote returns <p><br></p> when empty)
        const isEmpty = !newDescriptionHTML || newDescriptionHTML === '<p><br></p>' || newDescriptionHTML === '';

        // Validate
        if (isEmpty) {
            alert('กรุณากรอกรายการ');
            return;
        }

        if (newAmount <= 0) {
            alert('กรุณากรอกจำนวนเงินที่ถูกต้อง');
            return;
        }

        // Destroy Summernote
        $(textarea).summernote('destroy');

        // Update hidden inputs (store original HTML)
        item.querySelector('.item-description-hidden').value = newDescriptionHTML;
        item.querySelector('.item-amount-hidden').value = newAmount;

        // Update display (convert HTML to text with line breaks preserved)
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = newDescriptionHTML;

        // Replace block elements with newlines before getting text
        tempDiv.querySelectorAll('p, div, br').forEach(el => {
            if (el.tagName === 'BR') {
                el.replaceWith('\n');
            } else {
                el.insertAdjacentText('afterend', '\n');
            }
        });

        const plainText = (tempDiv.textContent || tempDiv.innerText || '').trim();
        const displayDescription = plainText.replace(/\n/g, '<br>');

        item.querySelector('.item-description-display').innerHTML = displayDescription;
        item.querySelector('.item-amount-display').textContent = newAmount.toLocaleString();

        // Show display mode, hide edit mode
        item.querySelector('.item-display-mode').style.display = 'block';
        item.querySelector('.item-edit-mode').style.display = 'none';

        // Recalculate total
        calculateTotal();
    }
}

// Calculate total amount
function calculateTotal() {
    let total = 0;
    let itemCount = 0;
    
    // Use the hidden input fields to calculate total
    document.querySelectorAll('.item-amount-hidden').forEach(input => {
        const value = parseFloat(input.value) || 0;
        total += value;
        if (value > 0) itemCount++;
    });
    
    // Format number with commas for Thai display
    const formattedTotal = formatNumber(total);
    
    const totalField = document.getElementById('total_amount');  // hidden field
    const totalDisplayField = document.getElementById('total_amount_display');  // display field
    const totalTextField = document.getElementById('total_amount_text');
    
    // อัปเดต hidden field ด้วยค่าตัวเลขล้วนๆ
    if (totalField) {
        totalField.value = total;
    }
    
    // อัปเดต display field ด้วยค่าที่มีจุลภาค
    if (totalDisplayField) {
        totalDisplayField.value = formattedTotal;
    }
    
    if (totalTextField) {
        totalTextField.value = convertToThaiText(total);
    }
}

// Format number with commas
function formatNumber(num) {
    if (num === null || num === undefined || num === '') return '0.00';
    
    // แปลงเป็นตัวเลขก่อน
    const number = Number(num);
    if (isNaN(number)) return '0.00';
    
    // แบบง่ายๆ ไม่ใช้ regex
    const str = number.toFixed(2);
    const parts = str.split('.');
    const integerPart = parts[0];
    const decimalPart = parts[1];
    
    // เพิ่มจุลภาคทีละ 3 หลัก
    let formatted = '';
    for (let i = integerPart.length - 1, count = 0; i >= 0; i--, count++) {
        if (count > 0 && count % 3 === 0) {
            formatted = ',' + formatted;
        }
        formatted = integerPart[i] + formatted;
    }
    
    return formatted + '.' + decimalPart;
}

// Convert number to Thai text
function convertToThaiText(amount) {
    // ตรวจสอบ input ก่อน
    if (!amount || isNaN(amount) || amount <= 0) return 'ศูนย์บาทถ้วน';
    
    const ones = ['', 'หนึ่ง', 'สอง', 'สาม', 'สี่', 'ห้า', 'หก', 'เจ็ด', 'แปด', 'เก้า'];
    const units = ['', 'สิบ', 'ร้อย', 'พัน', 'หมื่น', 'แสน', 'ล้าน', 'สิบล้าน', 'ร้อยล้าน', 'พันล้าน'];
    
    function convertIntegerPart(num) {
        if (!num || num === 0) return '';
        
        let result = '';
        let unitIndex = 0;
        
        while (num > 0) {
            let digit = num % 10;
            
            if (digit > 0) {
                let digitText = '';
                
                if (unitIndex === 1) { // หลักสิบ
                    if (digit === 1) {
                        digitText = 'สิบ';
                    } else if (digit === 2) {
                        digitText = 'ยี่สิบ';
                    } else {
                        digitText = ones[digit] + 'สิบ';
                    }
                } else { // หลักอื่นๆ
                    // กรณีพิเศษสำหรับ "หนึ่ง" ในหลักที่มากกว่าหลักหน่วย
                    if (digit === 1 && unitIndex > 1) {
                        // ถ้าเป็น "หนึ่ง" ในหลักร้อย, พัน, หมื่น, แสน ให้ใส่ "หนึ่ง"
                        // แต่ถ้าเป็นหลักล้านขึ้นไป และเป็นเลข 1 ในหลักสูงสุด ให้ไม่ใส่ "หนึ่ง"
                        if (unitIndex >= 6 && num < 10) { // ล้าน, สิบล้าน, ร้อยล้าน และเป็นหลักเดียว
                            digitText = units[unitIndex];
                        } else {
                            digitText = ones[digit] + units[unitIndex];
                        }
                    } else {
                        digitText = ones[digit];
                        if (unitIndex > 0 && units[unitIndex]) {
                            digitText += units[unitIndex];
                        }
                    }
                }
                
                result = digitText + result;
            }
            
            num = Math.floor(num / 10);
            unitIndex++;
        }
        
        return result;
    }
    
    // แปลงเป็น number และตรวจสอบ
    const numAmount = Number(amount);
    if (isNaN(numAmount)) return 'จำนวนเงินไม่ถูกต้อง';
    
    const integerPart = Math.floor(numAmount);
    const decimalPart = Math.round((numAmount - integerPart) * 100);
    
    let result = '';
    
    // ส่วนบาท
    const bahtText = convertIntegerPart(integerPart);
    result = (bahtText || 'ศูนย์') + 'บาท';
    
    // ส่วนสตางค์
    if (decimalPart > 0) {
        const satangText = convertIntegerPart(decimalPart);
        result += satangText + 'สตางค์';
    } else {
        result += 'ถ้วน';
    }
    
    return result;
}

// Form actions
function updateDraft() {
    updateReceipt('draft', false);
}

// Show confirmation modal before completing
function showCompleteConfirmation() {
    // Validate form first
    const form = document.getElementById('receiptForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    // Check items
    const items = [];
    document.querySelectorAll('.item-row').forEach(row => {
        const description = row.querySelector('.item-description-hidden').value.trim();
        const amount = parseFloat(row.querySelector('.item-amount-hidden').value) || 0;

        if (description && amount > 0) {
            items.push({
                description: description,
                amount: amount
            });
        }
    });

    if (items.length === 0) {
        alert('กรุณาเพิ่มรายการรับเงิน');
        return;
    }

    // Populate modal with data
    document.getElementById('confirm-recipient-name').textContent = document.getElementById('recipient_name').value;
    document.getElementById('confirm-id-card').textContent = document.getElementById('recipient_id_card').value;

    const totalAmount = parseFloat(document.getElementById('total_amount').value || 0);
    document.getElementById('confirm-total-amount').textContent = totalAmount.toLocaleString('th-TH', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }) + ' บาท';

    // Show items list
    let itemsHTML = '<ul class="mb-0">';
    items.forEach((item, index) => {
        itemsHTML += `<li>${item.description}: ${item.amount.toLocaleString('th-TH', {minimumFractionDigits: 2})} บาท</li>`;
    });
    itemsHTML += '</ul>';
    document.getElementById('confirm-items-list').innerHTML = itemsHTML;

    // Reset checkbox
    document.getElementById('confirmCheckbox').checked = false;
    document.getElementById('confirmCompleteBtn').disabled = true;

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('completeConfirmationModal'));
    modal.show();
}

// Toggle confirm button based on checkbox
function toggleConfirmButton() {
    const checkbox = document.getElementById('confirmCheckbox');
    const confirmBtn = document.getElementById('confirmCompleteBtn');
    confirmBtn.disabled = !checkbox.checked;
}

// Open preview PDF in new window
function openPreviewPDF() {
    window.open(`/accounts/receipt/${savedReceiptId}/pdf/`, '_blank');
}

// Confirm and complete receipt
function confirmComplete() {
    // Hide modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('completeConfirmationModal'));
    modal.hide();

    // Save and complete
    updateReceipt('completed', true);
}

// Legacy function (kept for backward compatibility)
function updateAndComplete() {
    showCompleteConfirmation();
}

function updateReceipt(status, redirectToDetail = false) {
    // Validate form
    const form = document.getElementById('receiptForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    // Check items
    const items = [];
    document.querySelectorAll('.item-row').forEach(row => {
        const description = row.querySelector('.item-description-hidden').value.trim();
        const amount = parseFloat(row.querySelector('.item-amount-hidden').value) || 0;

        if (description && amount > 0) {
            items.push({
                description: description,
                amount: amount
            });
        }
    });

    if (items.length === 0) {
        alert('กรุณาเพิ่มรายการรับเงิน');
        return;
    }

    // Prepare data
    const data = {
        recipient_name: document.getElementById('recipient_name').value,
        recipient_address: document.getElementById('recipient_address').value,
        recipient_postal_code: document.getElementById('recipient_postal_code').value,
        recipient_id_card: document.getElementById('recipient_id_card').value,
        is_loan: document.querySelector('input[name="is_loan"]:checked').value === 'true',
        total_amount: parseFloat(document.getElementById('total_amount').value || 0),
        status: status,
        items: items
    };

    // Show loading
    let submitBtn;
    if (redirectToDetail) {
        submitBtn = document.querySelector('button[onclick="updateAndComplete()"]');
    } else {
        submitBtn = document.querySelector('button[onclick="updateDraft()"]');
    }

    if (submitBtn) {
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> กำลังอัปเดต...';
        submitBtn.disabled = true;

        // เก็บ reference เพื่อใช้ใน finally
        window.tempSubmitBtn = submitBtn;
        window.tempOriginalText = originalText;
    }

    // Send AJAX request
    fetch(`/accounts/receipt/${savedReceiptId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const receiptNumberText = data.receipt_number ? `เลขที่: ${data.receipt_number}` : '(ร่าง - ยังไม่มีเลข)';
            if (redirectToDetail) {
                showToast('success', 'บันทึกสำเร็จ!', `${receiptNumberText}<br>กำลังนำไปยังหน้ารายละเอียด...`);
                setTimeout(() => {
                    window.location.href = `/receipt/${savedReceiptId}/`;
                }, 2000);
            } else {
                showToast('success', 'บันทึกร่างสำเร็จ!', receiptNumberText);
                // Re-enable button after saving draft
                if (window.tempSubmitBtn) {
                    window.tempSubmitBtn.innerHTML = window.tempOriginalText;
                    window.tempSubmitBtn.disabled = false;
                    window.tempSubmitBtn = null;
                    window.tempOriginalText = null;
                }
            }
        } else {
            showToast('error', 'เกิดข้อผิดพลาด', data.message || 'ไม่สามารถบันทึกได้');
            // Re-enable button on error
            if (window.tempSubmitBtn) {
                window.tempSubmitBtn.innerHTML = window.tempOriginalText;
                window.tempSubmitBtn.disabled = false;
                window.tempSubmitBtn = null;
                window.tempOriginalText = null;
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'เกิดข้อผิดพลาด', 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์');
        // Re-enable button on error
        if (window.tempSubmitBtn) {
            window.tempSubmitBtn.innerHTML = window.tempOriginalText;
            window.tempSubmitBtn.disabled = false;
            window.tempSubmitBtn = null;
            window.tempOriginalText = null;
        }
    });
}

// Show toast notification
function showToast(type, title, message) {
    const toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) return;

    const toastId = 'toast-' + Date.now();
    const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';

    const toastHTML = `
        <div id="${toastId}" class="toast align-items-center ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true" style="margin-left: auto;">
            <div class="d-flex">
                <div class="toast-body">
                    <strong>${title}</strong><br>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;

    toastContainer.insertAdjacentHTML('beforeend', toastHTML);

    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: 4000
    });

    toast.show();

    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}
</script>

<style>
/* Tab styling */
.nav-tabs-custom {
    border-bottom: 2px solid #e5e7eb;
}

.nav-tabs-custom .nav-link {
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    color: #6b7280;
    font-weight: 500;
    padding: 12px 20px;
    margin-bottom: -2px;
    transition: all 0.3s ease;
}

.nav-tabs-custom .nav-link:hover {
    color: #002F6C;
    border-bottom-color: #CFAE43;
    background-color: rgba(207, 174, 67, 0.1);
}

.nav-tabs-custom .nav-link.active {
    color: #002F6C;
    border-bottom-color: #CFAE43;
    background-color: rgba(207, 174, 67, 0.1);
    font-weight: 600;
}

/* Item styling */
.item-row {
    background-color: #fff;
    transition: all 0.2s ease;
    border: 1px solid #e5e7eb !important;
}

.item-row:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border-color: #CFAE43 !important;
}

/* Form styling */
.tab-content {
    padding-top: 20px;
}

.form-control:focus {
    border-color: #CFAE43;
    box-shadow: 0 0 0 0.2rem rgba(207, 174, 67, 0.25);
}

.btn-success {
    background-color: #CFAE43;
    border-color: #CFAE43;
}

.btn-success:hover {
    background-color: #b8951a;
    border-color: #b8951a;
}

.toast-body {
    padding: 1rem;
    color: white !important;
}

.toast-body * {
    color: white !important;
}
</style>

<!-- jQuery (required for Summernote) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Summernote JS -->
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-bs4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/lang/summernote-th-TH.min.js"></script>
<script>
$(document).ready(function() {
    // Initialize Summernote for multi-item description (Simple mode)
    $('#multi-item-description').summernote({
        height: 200,
        lang: 'th-TH',
        toolbar: [
            // เหลือแค่ undo/redo และ fullscreen เท่านั้น
            ['view', ['fullscreen', 'codeview']]
        ],
        placeholder: 'พิมพ์รายการรับเงิน (กด Enter เพื่อขึ้นบรรทัดใหม่)',
        disableDragAndDrop: true,
        fontNames: ['Sarabun', 'THSarabunNew', 'Arial', 'Tahoma'],
        fontNamesIgnoreCheck: ['Sarabun', 'THSarabunNew']
    });
});
</script>
{% endblock %}